<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solace Message Utility</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyNTAgMjUwIiB3aWR0aD0iMjUwIiBoZWlnaHQ9IjI1MCI+CiAgPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI5LjYuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDIuMS4xIEJ1aWxkIDkpICAtLT4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLnN0MCB7CiAgICAgICAgZmlsbDogI2ZmZjsKICAgICAgfQoKICAgICAgLnN0MSB7CiAgICAgICAgZmlsbDogIzNkYmE5MTsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2RlZnM+CiAgPHBhdGggY2xhc3M9InN0MSIgZD0iTTI0NSwxMjVjMCw2Ni4zLTUzLjcsMTIwLTEyMCwxMjBTNSwxOTEuMyw1LDEyNSw1OC43LDUsMTI1LDVzMTIwLDUzLjcsMTIwLDEyMCIvPgogIDxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik03MC42LDEwNC41YzAtNi40LDEuNC0xMiw0LjMtMTYuNiwyLjgtNC42LDYuNS04LjQsMTEtMTEuNCw0LjUtMyw5LjYtNS4yLDE1LjItNi43LDUuNi0xLjUsMTEuMi0yLjIsMTYuOS0yLjJzMTAuMy41LDE0LjksMS40YzQuNi45LDguNiwyLjIsMTIuMSwzLjgsMy40LDEuNiw2LjIsMy40LDguMiw1LjUsMiwyLjEsMyw0LjMsMyw2LjgsMCwzLjUsMCw2LjMtLjIsOC4zLS4y,MiwtLjUsMy41LS45LDQuNS0uNSwxLTEsMS42LTEuNiwxLjgtLjYuMi0xLjQuMy0yLjMuMy0yLjYsMC00LjctMS02LjMtMi45LTEuNi0xLjktMy40LTQuMS01LjQtNi40LTItMi40LTQuNi00LjUtNy43LTYuNC0zLjEtMS45LTcuNy0yLjktMTMuNy0yLjlzLTYuNS41LTguOCwxLjRjLTIuNC45LTQuMywyLjEtNS42LDMuNy0xLjQsMS41LTIuNCwzLjItMyw0LjktLjYsMS44LS45LDMuNS0uOSw1LjIsMCwzLjcsMS41LDYuNCw0LjYsOC4zLDMuMSwxLjgsNi45LDMuNCwxMS41LDQuNyw0LjYsMS4zLDkuNSwyLjUsMTQuOCwzLjcsNS4zLDEuMSwxMC4yLDIuOCwxNC44LDQuOSw0LjYsMi4xLDguNCw1LjEsMTEuNSw5LDMuMSwzLjgsNC42LDksNC42LDE1LjRzLTEuMiwxMS42LTMuNywxNi42Yy0yLjUsNC45LTUuOSw5LTEwLjIsMTIuNC00LjQsMy40LTkuNyw2LTE1LjksNy44LTYuMiwxLjgtMTMsMi44LTIwLjMsMi44cy0xMi44LS45LTE4LjMtMi44Yy01LjQtMS44LTEwLjEtNC4xLTE0LTYuOC0zLjktMi43LTYuOS01LjQtOS4xLTguMi0yLjEtMi44LTMuMi01LjEtMy4yLTYuOSwwLTIuNi44LTUuMiwyLjMtNy44LDEuNS0yLjYsMy44LTMuOSw2LjktMy45czMuNy42LDUuMSwxLjdjMS40LDEuMSwyLjcsMi41LDMuOSw0LjEsMS4yLDEuNiwyLjUsMy40LDMuOCw1LjQsMS4zLDIsMi45LDMuOCw0LjgsNS40LDEuOSwxLjYsNC4yLDMsNi45LDQuMSwyLjcsMS4yLDYsMS43LDEwLDEuNyw2LDAsMTEtMS41LDE1LjEtNC42LDQuMS0zLjEsNi4xLTcsNi4xLTExLjdzLTEuNS03LjItNC41LTkuM2MtMy0yLjEtNi43LTMuOC0xMSuMy01LjEtNC41LTEuMy05LjQtMi41LTE0LjctMy42LTUuMy0xLjEtMTAuMi0yLjYtMTQuNy00LjctNC41LTIuMS04LjMtNS0xMS4zLTguOC0zLTMuOC00LjUtOS4yLTQuNS0xNi4xIi8+CiAgPHBhdGggY2xhc3M9InN0MCIgZD0JNzAuNCwxNjQuOGMwLTkuNiw3LjgtMTcuMywxNy4zLTE3LjNzMTcuMyw3LjgsMTcuMywxNy4zLTcuOCwxNy4zLTE3LjMsMTcuMy0xNy4zLTcuOC0xNy4zLTE3LjMiLz4KPC9zdmc+">
    <!-- Solace Library Loader -->
    <script>
        (function () {
            window.solaceLibLoaded = false;
            window.jszipLoaded = false;

            // Global Version Comparator
            window.compareVersions = function (v1, v2) {
                const p1 = (v1 || '0').split('.').map(Number);
                const p2 = (v2 || '0').split('.').map(Number);
                for (let i = 0; i < Math.max(p1.length, p2.length); i++) {
                    const n1 = p1[i] || 0;
                    const n2 = p2[i] || 0;
                    if (n1 > n2) return 1;
                    if (n1 < n2) return -1;
                }
                return 0;
            };

            function showBanner(msg) {
                const banner = document.getElementById('missing-lib-banner');
                if (banner) {
                    if (msg) banner.innerHTML = msg;
                    banner.style.display = 'block';
                }
            }

            // Solclient Loader
            function loadSolclient(src, fallback) {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`Loaded ${src}`);

                    // Version Check (>= 10.18.3)
                    const MIN_VERSION = '10.18.3';
                    const currentVersion = (window.solace && window.solace.Version && window.solace.Version.version) || '0.0.0';
                    console.log(`Solace API Version: ${currentVersion}`);

                    if (window.compareVersions(currentVersion, MIN_VERSION) >= 0) {
                        window.solaceLibLoaded = true;
                        window.dispatchEvent(new CustomEvent('Solclient:loaded'));
                    } else {
                        const err = `Solace API Version ${currentVersion} is too old. Required: ${MIN_VERSION}+`;
                        console.error(err);
                        showBanner(`⚠️ <strong>Outdated Library</strong>: Found Solclient ${currentVersion}, required ${MIN_VERSION}+.`);
                    }
                };
                script.onerror = () => {
                    console.warn(`Failed to load ${src}`);
                    if (fallback) {
                        loadSolclient(fallback, null); // Try fallback
                    } else {
                        console.error('Solace Client API missing.');
                        const msg = `⚠️ <strong>solclient.js</strong> not found. Please place it in the same directory.`;
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', () => showBanner(msg));
                        } else {
                            showBanner(msg);
                        }
                    }
                };
                document.head.appendChild(script);
            }

            // Start Solclient Load
            loadSolclient('solclient.js', 'js/solclient.js', 'solclient-full.js', 'js/solclient-full.js', 'solclient-debug.js', 'js/solclient-debug.js');

            // JSZip Loader
            const zipPaths = ['jszip.min.js', 'js/jszip.min.js', 'jszip.js', 'js/jszip.js'];
            function loadZip(index) {
                if (index >= zipPaths.length) {
                    console.warn('JSZip could not be loaded from any path.');
                    return;
                }
                const s = document.createElement('script');
                s.src = zipPaths[index];
                s.onload = () => {
                    console.log(`Loaded ${zipPaths[index]}`);

                    // Version Check (>= 3.10.1)
                    if (window.JSZip) {
                        const MIN_VERSION = '3.10.1';
                        // JSZip version is usually just window.JSZip.version
                        // Note: Some minified versions might strip it, but standard builds have it.
                        const v = window.JSZip.version || '0.0.0';
                        console.log(`JSZip Version: ${v}`);

                        // Clean version string just in case (e.g. "3.10.1")
                        if (window.compareVersions(v, MIN_VERSION) >= 0) {
                            window.jszipLoaded = true;
                            window.dispatchEvent(new CustomEvent('jszip:loaded'));
                        } else {
                            console.error(`JSZip version ${v} is too old. Required: ${MIN_VERSION}+`);
                            // Not setting jszipLoaded = true
                        }
                    } else {
                        console.warn('JSZip loaded but window.JSZip object not found.');
                    }
                };
                s.onerror = () => {
                    loadZip(index + 1);
                };
                document.head.appendChild(s);
            }
            loadZip(0);

        })();
    </script>

<style>
/* Core Styles */
:root {
    /* Color Palette - Solace Brand */
    --solace-green: #00C895;
    --solace-green-light: #ABFF88;
    --solace-dark-blue: #093B5F;
    --solace-darker-blue: #03213B;
    --solace-white: #ffffff;

    /* Tertiary */
    --solace-mint: #C7FFCB;
    --solace-sky: #C2F7FF;
    --solace-yellow: #FFF7C2;
    --solace-teal: #009193;
    /* Good for hover/active */
    --solace-orange: #FCAB29;
    /* Good for warning */

    /* App Theme Mapping - Mellow Flat Theme */
    --bg-app: #f8f9fa;
    /* Main content light */
    --bg-sidebar: #03213B;
    /* Solace Darker Blue */
    --bg-header: #ffffff;
    --bg-card: #ffffff;
    --bg-input: #f1f5f9;

    --text-primary: #334155;
    /* Dark Slate */
    --text-secondary: #64748b;
    --text-muted: #94a3b8;

    --accent-primary: #00C895;
    /* Solace Green */
    --accent-secondary: #009193;
    /* Solace Teal */
    --accent-hover: #00a87d;
    --accent-text: #ffffff;

    --border-color: #e2e8f0;

    --status-connected: #00C895;
    --status-disconnected: #ef4444;
    --status-warning: #FCAB29;
    --status-error: #ef4444;
    /* Standard error red */

    /* Spacing & Layout */
    --sidebar-width: 260px;
    --header-height: 64px;
    --radius-md: 6px;
    --radius-lg: 8px;

    /* Effects */
    --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --glass-bg: #fff;
    /* Disabled glass */
    --glass-border: transparent;
}

/* Notification Banner */
.notification-banner {
    background-color: var(--status-disconnected);
    color: white;
    text-align: center;
    padding: 0.75rem;
    font-weight: 600;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    display: none;
    /* Hidden by default */
}

.notification-banner a {
    color: white;
    text-decoration: underline;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

*:disabled,
*[disabled] {
    cursor: not-allowed !important;
}

body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    /* Main vertical overflow hidden */
}

/* Layout */
.app-container {
    display: flex;
    height: 100vh;
    min-width: 800px;
    /* Enforce min width */
    overflow-x: auto;
    /* Allow horizontal scroll if < 800px */
}

/* Sidebar */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--bg-sidebar);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    /* Subtle border for dark sidebar */
    display: flex;
    flex-direction: column;
    z-index: 10;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    /* For toggle button positioning if needed */
    flex-shrink: 0;
    /* Prevent shrinking below set width */
    color: white;
    /* Force white text in dark sidebar */
}

.sidebar.collapsed {
    width: 64px;
}

/* Logic: Hide Text/Full elements when collapsed */
.sidebar.collapsed .logo-full,
.sidebar.collapsed .logo-text,
.sidebar.collapsed .nav-text {
    display: none !important;
}

/* Logic: Show Icon Logo when collapsed */
.sidebar.collapsed .logo-icon {
    display: block !important;
    margin: 0 auto;
}

.sidebar.collapsed .sidebar-header {
    padding: 0;
    justify-content: center;
}

.sidebar-header {
    height: var(--header-height);
    display: flex;
    align-items: center;
    padding: 0 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    white-space: nowrap;
    /* Prevent text wrapping during transition */
    overflow: hidden;
}

.logo {
    font-size: 1.15rem;
    font-weight: 600;
    color: white;
    letter-spacing: -0.2px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
}

.sidebar-nav {
    flex: 1;
    padding: 1.5rem 0.75rem;
    overflow-y: auto;
    overflow-x: hidden;
}

.sidebar.collapsed .sidebar-nav {
    padding: 1.5rem 0.5rem;
    /* Reduce padding */
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 0.65rem 1rem;
    margin-bottom: 0.25rem;
    color: rgba(255, 255, 255, 0.7);
    /* Mellow white */
    text-decoration: none;
    border-color: var(--bg-sidebar);
    border-style: solid;
    border-width: 1px;
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
}

.sidebar.collapsed .nav-item {
    justify-content: center;
    padding: 0.75rem 0;
}

.nav-icon {
    margin-right: 0.75rem;
    font-size: 1.2rem;
    min-width: 1.5rem;
    /* Ensure stable width for icon alignment */
    text-align: center;
    /* Center the icon in its slot */
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar.collapsed .nav-icon {
    margin-right: 0;
}

.nav-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
}

.nav-item.active {
    background-color: var(--accent-secondary);
    border-color: var(--accent-primary);
    color: var(--accent-text);
    /* Usually dark text on green */
    font-weight: 600;
}

/* Sidebar Toggle */
.sidebar-toggle {
    position: absolute;
    right: -12px;
    top: 24px;
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    box-shadow: var(--shadow-sm);
    transition: transform 0.3s;
}

.sidebar.collapsed .sidebar-toggle {
    transform: rotate(180deg);
}

.sidebar-footer {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
}

/* Status Styles */

/* Validation */
.form-control.is-invalid {
    border-color: var(--status-disconnected);
}

.invalid-feedback {
    display: none;
    color: var(--status-disconnected);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.form-control.is-invalid+.invalid-feedback {
    display: block;
}

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-color: var(--bg-app);
    /* Flat color, no gradient */
}

.top-bar {
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-header);
    /* Removed backdrop filter for clean look */
}

#page-title {
    font-size: 1.25rem;
    font-weight: 600;
}

.module-view-container {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
}

/* UI Components */
.card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
}

.card h2,
.card h3 {
    font-weight: 600;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.form-control {
    width: 100%;
    padding: 0.625rem 0.875rem;
    background-color: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-md);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    font-size: 0.95rem;
}

.btn-primary {
    background-color: var(--accent-primary);
    color: var(--accent-text);
}

.btn:disabled,
.btn-primary:disabled {
    background-color: none;
    color: var(--text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    pointer-events: none;
    font-weight: normal;
}

.btn-primary:hover {
    background-color: var(--accent-hover);
}

.btn-secondary {
    background-color: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background-color: #475569;
}

.btn-danger {
    background-color: var(--status-disconnected);
    color: white;
}

.btn-success {
    background-color: var(--status-connected);
    color: white;
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid transparent;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    transition: all 0.2s;
}

.btn-icon:hover {
    background-color: var(--bg-input);
    color: var(--text-primary);
}

/* Bulk Action Hovers */
.hover-danger:not(:disabled):hover {
    background-color: var(--status-disconnected) !important;
    color: white !important;
    border-color: var(--status-disconnected) !important;
}

.hover-success:not(:disabled):hover {
    background-color: var(--status-connected) !important;
    color: white !important;
    border-color: var(--status-connected) !important;
}

.btn-icon:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: transparent !important;
    pointer-events: none;
    color: var(--text-muted);
}

/* Tables */
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.data-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-color);
    position: sticky;
    top: 0;
    background-color: var(--bg-card);
    /* Ensure content doesn't show through */
    z-index: 10;
}

.data-table td {
    padding: 0.35rem 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

.data-table tr:last-child td {
    border-bottom: none;
}

.data-table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.02);
}

/* Badge/Labels */
.badge {
    display: inline-flex;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-info {
    background-color: rgba(14, 165, 233, 0.2);
    color: var(--accent-primary);
}

.badge-success {
    background-color: rgba(16, 185, 129, 0.2);
    color: var(--status-connected);
}

/* Utilities */
.hidden {
    display: none !important;
}

.text-accent {
    color: var(--accent-primary) !important;
}

.text-secondary {
    color: var(--text-secondary) !important;
}

.text-error {
    color: var(--status-error) !important;
}

.text-center {
    text-align: center;
}

.text-left {
    text-align: left;
}

.text-right {
    text-align: right;
}

.font-bold {
    font-weight: 600;
}

.font-normal {
    font-weight: 400;
}

.cursor-pointer {
    cursor: pointer;
}

/* Flex Utilities */
.flex-row {
    display: flex;
    gap: 1rem;
}

.flex-col {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.flex-1 {
    flex: 1;
}

.flex-wrap {
    flex-wrap: wrap;
}

.inline-flex {
    display: inline-flex;
}

.items-center {
    align-items: center;
}

.items-end {
    align-items: flex-end;
}

.items-start {
    align-items: flex-start;
}

.justify-between {
    justify-content: space-between;
}

.justify-end {
    justify-content: flex-end;
}

.justify-center {
    justify-content: center;
}

.gap-0 {
    gap: 0;
}

.gap-1 {
    gap: 0.25rem;
}

.gap-2 {
    gap: 0.5rem;
}

.gap-4 {
    gap: 1rem;
}

/* Sizing */
.w-full {
    width: 100%;
}

.h-full {
    height: 100%;
}

.overflow-auto {
    overflow: auto;
}

/* Spacing */
.m-0 {
    margin: 0;
}

.p-0 {
    padding: 0;
}

.mt-1 {
    margin-top: 0.25rem;
}

.mt-2 {
    margin-top: 0.5rem;
}

.mt-4 {
    margin-top: 1rem;
}

.mb-1 {
    margin-bottom: 0.25rem;
}

.mb-2 {
    margin-bottom: 0.5rem;
}

.mb-3 {
    margin-bottom: 0.75rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.mb-6 {
    margin-bottom: 1.5rem;
}

.mr-2 {
    margin-right: 0.5rem;
}

.mr-4 {
    margin-right: 1rem;
}

.p-2 {
    padding: 0.5rem;
}

.p-4 {
    padding: 1rem;
}

.p-6 {
    padding: 1.5rem;
}

/* Components */
.divider {
    border: 0;
    border-top: 1px solid var(--border-color);
    margin: 1.5rem 0;
}

/* Modals */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-backdrop.hidden {
    display: none !important;
}

.modal-content {
    background-color: var(--bg-card);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    min-width: 400px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.modal-content.modal-lg {
    width: 800px;
    max-width: 95%;
    min-width: 600px;
}

.input-with-badge {
    position: relative;
    display: flex;
    align-items: center;
}



/* Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-app);
}

::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* Searchable Dropdown */
.searchable-select-container {
    position: relative;
    width: 100%;
}

.searchable-select-container input.form-control {
    padding-right: 2.5rem;
    /* Space for icon */
    cursor: text;
}

.searchable-select-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.dropdown-options {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 250px;
    overflow-y: auto;
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    z-index: 1000;
    margin-top: 4px;
    display: none;
}

.dropdown-options.show {
    display: block;
}

.dropdown-option {
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-primary);
}

.dropdown-option:hover {
    background-color: var(--bg-input);
}

/* Queue Browser Styles */
.browser-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, background-color 0.2s;
}

.btn-icon:hover {
    color: var(--accent-primary);
    background-color: var(--bg-input);
}

.clickable-row {
    cursor: pointer;
}

.data-table tr.selected td {
    background-color: var(--solace-mint) !important;
    color: var(--text-primary);
}

.data-table tr.selected:hover td {
    background-color: var(--solace-mint) !important;
}

.card-light {
    background-color: #f8fafc;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
}

.detail-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-secondary);
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.detail-box {
    font-family: monospace;
    font-size: 0.85rem;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    color: var(--text-primary);
    width: 100%;
    min-height: 38px;
    display: flex;
    align-items: center;
}

.detail-header-row {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
    height: 26px;
    /* Fixed height for alignment */
    margin-bottom: 0.25rem;
    white-space: nowrap;
}

.detail-header-row .detail-label {
    margin-bottom: 0;
}

.detail-textarea {
    font-family: monospace;
    font-size: 0.85rem;
    background-color: #fff;
    border-color: var(--border-color);
}

/* Info Bar */
.browser-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 1rem;
}

/* Filter Modal Dynamic Headers */
.filter-header-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.btn-remove-header {
    background: transparent;
    border: none;
    color: var(--status-disconnected);
    cursor: pointer;
    font-weight: bold;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 1.2rem;
    line-height: 1;
}

.btn-remove-header:hover {
    background-color: rgba(239, 68, 68, 0.1);
}

.browser-info-bar .info-group {
    display: flex;
    gap: 1.5rem;
}

.browser-info-bar .action-group {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.5rem;
}

.info-count strong {
    color: var(--text-primary);
}

/* Outlined Badges */
.badge-outline-info {
    border: 1px solid var(--accent-primary);
    color: var(--text-primary);
    background-color: transparent;
}

.badge-outline-success {
    border: 1px solid var(--status-connected);
    color: var(--text-primary);
    background-color: transparent;
}

.badge-outline-warning {
    border: 1px solid var(--status-warning);
    color: var(--text-primary);
    background-color: transparent;
}

/* Modal / Lightbox */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: flex-start;
    /* Aligns to top */
    justify-content: center;
    padding-top: 4rem;
    /* Top offset */
    z-index: 2000;
}

.modal-content {
    background-color: var(--bg-card);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    width: 400px;
    max-width: 90%;
}

.modal-content-raw {
    background-color: var(--bg-card);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    width: 70%;
    height: 70%;
    min-width: 500px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.modal-content-raw textarea {
    flex: 1;
    font-family: monospace;
    font-size: 0.85rem;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    margin-top: 1rem;
    resize: none;
}

.filter-active {
    color: var(--accent-primary) !important;
}

/* Sidebar Status Footer */
.sidebar-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-color);
    margin-top: auto;
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    /* Left align */
    gap: 1rem;
    /* Moderate gap between items */
}

.status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    /* Gap between icon and text */
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0;
}

.status-icon {
    color: var(--status-disconnected);
    transition: color 0.3s ease, filter 0.3s ease;
    flex-shrink: 0;
}

.status-connected {
    color: var(--status-connected);
    filter: drop-shadow(0 0 2px rgba(16, 185, 129, 0.6));
}

/* Collapsed Sidebar Adjustments */
.sidebar.collapsed .sidebar-footer {
    padding: 1rem 0;
    /* Vertical padding only */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    /* Vertical gap */
}

.sidebar.collapsed .status-label {
    display: none;
}

.sidebar.collapsed .status-item {
    justify-content: center;
    margin-bottom: 0;
}

/* Standardized Display Output Fields */
.display-output {
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    font-family: monospace;
    /* Consistent data display */
    font-size: 0.9rem;
    color: var(--text-primary);
}

.display-output.single-line {
    white-space: nowrap;
    overflow-x: auto;
    height: 38px;
    /* Match standard input height usually ~38px */
    display: flex;
    align-items: center;
}

.display-output.multi-line {
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    /* Preserve formatting */
    word-break: break-all;
}

.display-output.flex-wrap {
    min-height: 100px;
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-content: flex-start;
}

/* Header Tags (kept specifically for headers) */
.header-tag {
    background-color: #e2e8f0;
    color: var(--text-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-family: monospace;
    cursor: pointer;
    border: 1px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    max-width: 100%;
    transition: background-color 0.2s;
    user-select: none;
}

.header-tag:hover {
    background-color: #cbd5e1;
}

/* Flex Utilities */
.flex-1 {
    flex: 1;
}

.flex-2 {
    flex: 2;
}

.flex-3 {
    flex: 3;
}

/* Simple Spinner for Forwarding */
.spinner-sm {
    width: 16px;
    height: 16px;
    border: 2px solid var(--text-muted);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.icon-spin {
    animation: spin 1s linear infinite;
    transform-origin: center;
}

/* Missing Utilities */
.text-sm {
    font-size: 0.875rem;
}

.text-xs {
    font-size: 0.75rem;
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.whitespace-nowrap {
    white-space: nowrap;
}

.ml-7 {
    margin-left: 1.75rem;
}

.gap-3 {
    gap: 0.75rem;
}

.flex-shrink-0 {
    flex-shrink: 0;
}

.flex-grow {
    flex-grow: 1;
}

.min-w-0 {
    min-width: 0;
}

.border {
    border: 1px solid var(--border-color);
}

.rounded {
    border-radius: var(--radius-md);
}

.ml-2 {
    margin-left: 0.5rem;
}

.ml-7 {
    margin-left: 1.75rem;
}

/* Module Styles */



</style>

</head>

<body class="dark-theme">

    <script>
    window.APP_CONFIG = {"useMocks":true};
    </script>
    
    <!-- Missing Library Notification -->
    <div id="missing-lib-banner" class="notification-banner">
        ⚠️ <strong>solclient.js</strong> not found. Please place it in the same directory or in a "js" folder.
    </div>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="main-sidebar">
            <button class="sidebar-toggle" id="btn-sidebar-toggle" title="Toggle Sidebar">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div class="sidebar-header">
                <div class="logo">
                    <!-- Full Logo (Text/Wordmark) -->
                    <svg class="logo-full" width="133" height="40" viewBox="0 0 500 150">
                        <defs>
                            <style>
                                .st0 {
                                    fill: #3dba91;
                                }
                            </style>
                        </defs>
                        <path class="st0"
                            d="M14.3,82.5c0-4.4,1-8.2,2.9-11.3,1.9-3.1,4.4-5.7,7.5-7.8,3.1-2,6.5-3.6,10.4-4.6,3.8-1,7.7-1.5,11.5-1.5s7.1.3,10.2.9c3.1.6,5.9,1.5,8.2,2.6,2.4,1.1,4.2,2.4,5.6,3.8,1.4,1.4,2,3,2,4.6,0,2.4,0,4.3-.2,5.7-.1,1.4-.3,2.4-.6,3.1-.3.7-.7,1.1-1.1,1.3-.4.2-.9.2-1.6.2-1.8,0-3.2-.7-4.3-2-1.1-1.3-2.3-2.8-3.7-4.4-1.4-1.6-3.1-3.1-5.3-4.4-2.1-1.3-5.3-2-9.3-2s-4.4.3-6,.9c-1.6.6-2.9,1.5-3.8,2.5-.9,1-1.6,2.2-2,3.4-.4,1.2-.6,2.4-.6,3.5,0,2.5,1,4.4,3.1,5.7,2.1,1.3,4.7,2.3,7.8,3.2,3.1.9,6.5,1.7,10.1,2.5,3.6.8,7,1.9,10.1,3.4,3.1,1.5,5.8,3.5,7.9,6.1,2.1,2.6,3.1,6.1,3.1,10.5s-.8,8-2.5,11.3c-1.7,3.4-4,6.2-7,8.5-3,2.3-6.6,4.1-10.8,5.3-4.2,1.3-8.9,1.9-13.9,1.9s-8.8-.6-12.5-1.9c-3.7-1.3-6.9-2.8-9.6-4.6-2.7-1.8-4.7-3.7-6.2-5.6-1.5-1.9-2.2-3.5-2.2-4.7,0-1.8.5-3.6,1.6-5.3,1-1.8,2.6-2.7,4.7-2.7s2.5.4,3.5,1.2c.9.8,1.8,1.7,2.7,2.8.8,1.1,1.7,2.3,2.6,3.7.9,1.4,2,2.6,3.3,3.7,1.3,1.1,2.9,2,4.7,2.8,1.8.8,4.1,1.2,6.8,1.2,4.1,0,7.5-1,10.3-3.1,2.8-2.1,4.2-4.8,4.2-8s-1-4.9-3.1-6.4c-2-1.4-4.6-2.6-7.7-3.5-3.1-.9-6.4-1.7-10-2.4-3.6-.7-7-1.8-10-3.2-3.1-1.4-5.7-3.4-7.7-6-2-2.6-3.1-6.3-3.1-11" />
                        <path class="st0"
                            d="M124.6,66.8c-4,0-7.3.9-9.9,2.7-2.6,1.8-4.7,4.2-6.4,7.1-1.6,2.9-2.8,6.1-3.5,9.7-.7,3.5-1,6.9-1,10.1,0,4.9.5,9.2,1.6,13,1,3.7,2.5,6.8,4.4,9.3,1.9,2.5,4.1,4.3,6.7,5.6,2.6,1.3,5.3,1.9,8.2,1.9s5.7-.6,8.2-1.9c2.6-1.3,4.8-3.1,6.7-5.6,1.9-2.5,3.3-5.5,4.4-9.3,1-3.7,1.6-8,1.6-13,0-9.5-1.9-16.9-5.8-22-3.9-5.1-8.9-7.7-15.2-7.7M82.2,96.5c0-5.8,1.1-11,3.3-15.9,2.2-4.8,5.2-8.9,9.1-12.4,3.9-3.5,8.4-6.1,13.6-8,5.2-1.9,10.7-2.8,16.6-2.8s11.4.9,16.6,2.8c5.2,1.9,9.7,4.6,13.5,8,3.8,3.5,6.9,7.6,9.1,12.4,2.2,4.8,3.4,10.1,3.4,15.9s-1.1,11.2-3.4,15.9c-2.3,4.8-5.3,8.9-9.1,12.3-3.8,3.5-8.3,6.1-13.5,8-5.2,1.9-10.7,2.8-16.6,2.8s-11.4-.9-16.6-2.8c-5.2-1.9-9.7-4.6-13.6-8-3.9-3.5-6.9-7.6-9.1-12.3-2.2-4.8-3.3-10.1-3.3-15.9" />
                        <path class="st0"
                            d="M172.3,23.3c0-.8.9-1.8,2.7-2.8,1.8-1,4-2,6.5-2.9,2.5-.9,5.1-1.6,7.7-2.3,2.6-.6,4.7-.9,6.3-.9s1.3,0,1.9.2c.6.2,1.2.5,1.8,1.2.6.6,1,1.6,1.4,2.9.4,1.3.5,3.1.5,5.4v94.7c0,2.4.4,4.1,1.2,4.9.8.9,1.6,1.5,2.5,2,.9.4,1.7.8,2.5,1.3.8.4,1.2,1.4,1.2,2.8s-.5,2.5-1.6,3.2c-1,.7-2.4,1-3.9,1h-24.2c-1.6,0-2.9-.3-3.9-1-1-.7-1.6-1.8-1.6-3.2s.4-2.3,1.2-2.7c.8-.5,1.6-.9,2.5-1.3.9-.4,1.7-1.1,2.5-2,.8-.9,1.2-2.5,1.2-4.9V34.5c0-2-.4-3.4-1.3-4.2-.9-.8-1.9-1.4-2.9-1.9-1-.5-2-1-2.9-1.6-.9-.6-1.3-1.8-1.3-3.5" />
                        <path class="st0"
                            d="M254.4,93.3c-3.7,1.2-6.8,2.8-9.4,4.7-2.6,1.9-4.6,4.1-6,6.6-1.4,2.5-2.1,5-2.1,7.6s.3,3.6,1,5.3c.7,1.8,1.6,3.4,2.9,4.7,1.3,1.4,2.7,2.5,4.5,3.3,1.7.8,3.6,1.3,5.7,1.3s5.2-.7,7.2-2c2-1.3,3.6-2.9,4.9-4.7,1.3-1.8,2.2-3.7,2.7-5.7.6-1.9.9-3.6.9-4.9v-18.2c-4.5.1-8.6.8-12.2,2M220.5,69.7c0-1.9.9-3.6,2.6-5.1,1.7-1.5,4-2.8,6.8-3.8,2.8-1,6-1.9,9.5-2.4,3.5-.6,7-.9,10.4-.9,7,0,12.9.8,17.6,2.3,4.7,1.5,8.5,3.6,11.5,6.1,2.9,2.6,5,5.5,6.3,8.7,1.3,3.2,1.9,6.6,1.9,10v34.5c0,1.9.4,3.2,1.3,4.1.8.8,1.7,1.5,2.7,2,.9.5,1.8,1,2.7,1.5.8.5,1.3,1.4,1.3,2.7s-.4,2.5-1.2,3.4c-.8.9-2.7,1.3-5.7,1.3h-13.2c-2.4,0-4.1-.5-5.1-1.6-1-1-1.5-2.8-1.5-5.2v-1.7h-.6c-2.4,3.5-5.9,6-10.4,7.6-4.6,1.6-9.3,2.4-14.4,2.4s-8.5-.6-11.9-1.9c-3.4-1.3-6.3-3-8.6-5.1-2.4-2.1-4.1-4.6-5.3-7.5-1.2-2.8-1.8-5.8-1.8-8.8,0-5.2,1.6-9.7,4.8-13.5,3.2-3.8,7.3-6.8,12.2-9.2,5-2.4,10.5-4.1,16.6-5.2,6.1-1.1,12-1.6,17.9-1.6,0-4.7-1.3-8.6-4-11.5-2.7-3-6.6-4.5-11.7-4.5s-5.7.5-7.5,1.4c-1.9.9-3.6,2-5.1,3.1-1.5,1.2-3.1,2.2-4.7,3.1-1.6.9-3.7,1.4-6.2,1.4s-3.8-.5-5-1.6c-1.3-1.1-1.9-2.6-1.9-4.6" />
                        <path class="st0"
                            d="M301.5,97.6c0-5.9,1-11.3,3.1-16.2,2.1-4.9,4.9-9.2,8.6-12.7,3.6-3.6,7.9-6.3,12.9-8.3,5-2,10.4-3,16.2-3s7.2.4,10.8,1.3c3.5.9,6.6,2.1,9.3,3.5,2.7,1.5,4.9,3.2,6.5,5.2,1.6,2,2.4,4.1,2.4,6.3s-.9,4.1-2.7,5.5c-1.8,1.4-4.2,2-7.2,2s-4.1-.8-5.3-2.4c-1.2-1.6-2.4-3.4-3.5-5.3-1.1-1.9-2.4-3.6-4-5.3-1.6-1.6-3.9-2.4-7.1-2.4s-5.2.8-7.5,2.3c-2.3,1.5-4.2,3.7-5.9,6.5-1.7,2.8-3,6.2-3.8,10-.9,3.9-1.3,8.2-1.3,12.9s.6,7.9,1.8,11.2c1.2,3.3,2.8,6.1,4.8,8.4,2,2.3,4.3,4.1,6.9,5.3,2.6,1.2,5.4,1.8,8.3,1.8s6.9-.6,9.4-1.9c2.5-1.3,4.7-2.6,6.4-4.2,1.8-1.5,3.3-2.9,4.6-4.2,1.3-1.3,2.6-1.9,4-1.9s2,.3,2.7,1c.8.7,1.2,1.6,1.2,2.7,0,1.7-.8,3.6-2.5,5.9-1.7,2.3-4,4.4-6.9,6.4-2.9,2-6.4,3.8-10.4,5.2-4,1.4-8.4,2.1-13.1,2.1s-10.7-.9-15.5-2.7c-4.8-1.8-8.9-4.4-12.3-7.8-3.5-3.3-6.2-7.4-8.2-12-2-4.7-3-9.8-3-15.5" />
                        <path class="st0"
                            d="M423.2,65.9c-3.4,0-6.3.7-8.9,2.2-2.6,1.5-4.9,3.5-6.8,6.1-1.9,2.6-3.3,5.8-4.3,9.4-1,3.7-1.5,7.7-1.5,12.1v.9c3.5-.3,7.1-.9,11-1.7,3.9-.8,7.4-2,10.7-3.5,3.2-1.5,5.9-3.4,8.1-5.7,2.1-2.4,3.2-5.3,3.2-8.7s-.9-5.9-2.7-8c-1.8-2.1-4.7-3.1-8.7-3.1M380,98.4c0-5.7.9-11,2.7-15.9,1.8-5,4.5-9.3,8.2-13,3.7-3.7,8.3-6.6,13.9-8.8,5.6-2.1,12.2-3.2,19.9-3.2s6.8.4,10.4,1.2c3.6.8,6.8,2,9.8,3.8,3,1.7,5.4,4,7.4,6.8,1.9,2.8,2.9,6.1,2.9,10s-1.6,9-4.9,12.2c-3.3,3.2-7.5,5.8-12.6,7.7-5.1,1.9-10.8,3.4-16.9,4.3-6.1.9-12,1.6-17.7,1.9.5,3.1,1.5,5.9,2.9,8.3,1.4,2.4,3.1,4.4,5.2,6,2,1.6,4.2,2.8,6.6,3.6,2.4.8,4.7,1.2,7.1,1.2s5-.3,7.2-.9c2.2-.6,4.2-1.3,6-2.3,1.8-.9,3.5-2,4.9-3.1,1.5-1.1,2.8-2.2,3.9-3.2,1-1,2-1.9,2.8-2.4.8-.6,1.8-.9,3-.9,2.4,0,3.6,1.2,3.6,3.6s-1,4-3,6.4c-2,2.4-4.7,4.6-8,6.7-3.4,2-7.2,3.8-11.5,5.2-4.3,1.4-8.9,2.1-13.7,2.1s-10.9-.9-15.8-2.8c-4.9-1.9-9.1-4.5-12.7-7.8-3.6-3.3-6.4-7.2-8.5-11.8-2-4.6-3.1-9.5-3.1-14.8" />
                        <path class="st0"
                            d="M464.7,123.7c0-6.5,5.3-11.8,11.8-11.8s11.8,5.3,11.8,11.8-5.3,11.8-11.8,11.8-11.8-5.3-11.8-11.8" />
                    </svg>

                    <!-- Icon Logo (Shown when collapsed) -->
                    <svg class="logo-icon" width="32" height="32" viewBox="0 0 250 250"
                        xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path fill="#3dba91"
                            d="M245,125c0,66.3-53.7,120-120,120S5,191.3,5,125,58.7,5,125,5s120,53.7,120,120" />
                        <path fill="#ffffff"
                            d="M70.6,104.5c0-6.4,1.4-12,4.3-16.6,2.8-4.6,6.5-8.4,11-11.4,4.5-3,9.6-5.2,15.2-6.7,5.6-1.5,11.2-2.2,16.9-2.2s10.3.5,14.9,1.4c4.6.9,8.6,2.2,12.1,3.8,3.4,1.6,6.2,3.4,8.2,5.5,2,2.1,3,4.3,3,6.8,0,3.5,0,6.3-.2,8.3-.2,2-.5,3.5-.9,4.5-.5,1-1,1.6-1.6,1.8-.6.2-1.4.3-2.3.3-2.6,0-4.7-1-6.3-2.9-1.6-1.9-3.4-4.1-5.4-6.4-2-2.4-4.6-4.5-7.7-6.4-3.1-1.9-7.7-2.9-13.7-2.9s-6.5.5-8.8,1.4c-2.4.9-4.3,2.1-5.6,3.7-1.4,1.5-2.4,3.2-3,4.9-.6,1.8-.9,3.5-.9,5.2,0,3.7,1.5,6.4,4.6,8.3,3.1,1.8,6.9,3.4,11.5,4.7,4.6,1.3,9.5,2.5,14.8,3.7,5.3,1.1,10.2,2.8,14.8,4.9,4.6,2.1,8.4,5.1,11.5,9,3.1,3.8,4.6,9,4.6,15.4s-1.2,11.6-3.7,16.6c-2.5,4.9-5.9,9-10.2,12.4-4.4,3.4-9.7,6-15.9,7.8-6.2,1.8-13,2.8-20.3,2.8s-12.8-.9-18.3-2.8c-5.4-1.8-10.1-4.1-14-6.8-3.9-2.7-6.9-5.4-9.1-8.2-2.1-2.8-3.2-5.1-3.2-6.9,0-2.6.8-5.2,2.3-7.8,1.5-2.6,3.8-3.9,6.9-3.9s3.7.6,5.1,1.7c1.4,1.1,2.7,2.5,3.9,4.1,1.2,1.6,2.5,3.4,3.8,5.4,1.3,2,2.9,3.8,4.8,5.4,1.9,1.6,4.2,3,6.9,4.1,2.7,1.2,6,1.7,10,1.7,6,0,11-1.5,15.1-4.6,4.1-3.1,6.1-7,6.1-11.7s-1.5-7.2-4.5-9.3c-3-2.1-6.7-3.8-11.3-5.1-4.5-1.3-9.4-2.5-14.7-3.6-5.3-1.1-10.2-2.6-14.7-4.7-4.5-2.1-8.3-5-11.3-8.8-3-3.8-4.5-9.2-4.5-16.1" />
                        <path fill="#ffffff"
                            d="M170.4,164.8c0-9.6,7.8-17.3,17.3-17.3s17.3,7.8,17.3,17.3-7.8,17.3-17.3,17.3-17.3-7.8-17.3-17.3" />
                    </svg>

                    <span class="logo-text" style="display: block;">Msg Utility</span>
                </div>
            </div>
            <nav id="sidebar-nav" class="sidebar-nav">
                <!-- Navigation items injected by App logic -->
            </nav>
            <div class="sidebar-footer" id="sidebar-status-footer">
                <div class="status-item">
                    <!-- Client Icon (Activity/Signal) -->
                    <svg id="status-indicator-client" class="status-icon" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    <span class="status-label">Client</span>
                </div>
                <div class="status-item">
                    <!-- SEMP Icon (Server/Database) -->
                    <svg id="status-indicator-semp" class="status-icon" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                    </svg>
                    <span class="status-label">SEMP</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Welcome</h1>
                <div class="top-bar-actions">
                    <!-- Global actions if any -->
                </div>
            </header>

            <div id="module-container" class="module-view-container">
                <!-- Dynamic Module Content Loaded Here -->
                <div class="empty-state">
                    <p>Select a module from the sidebar to begin.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast / Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        
// --- Core App Logic ---

// Core Application Object
window.App = (function () {
    const modules = {};

    // Default State
    // const useMocks = window.APP_CONFIG ? window.APP_CONFIG.useMocks : false;
    const state = {
        activeModuleId: null,
        isConnected: false, // Mock global connection state
        selectedVpn: null,
        sempCredentials: null, // { user, pass }
        isSempConnected: false
    };

    // DOM Elements - to be cached on init
    let sidebarNav = null;
    let moduleContainer = null;
    let pageTitle = null;

    function init() {
        console.log(`App Initializing... v${window.App.VERSION}`);
        sidebarNav = document.getElementById('sidebar-nav');
        moduleContainer = document.getElementById('module-container');
        pageTitle = document.getElementById('page-title');

        // Clear initial static content (Empty State)
        if (moduleContainer) moduleContainer.innerHTML = '';

        renderSidebar();

        // Initialize ALL modules to ensure event listeners are registered
        const moduleIds = Object.keys(modules).sort();
        moduleIds.forEach(id => {
            ensureModuleRendered(id);
        });

        // Activate the first module (View)
        if (moduleIds.length > 0) {
            loadModule(moduleIds[0]);
        }
    }

    function registerModule(id, setupFunc) {
        console.log(`Registering module: ${id}`);
        // Infer a human readable name from the folder name (e.g. "01-connections" -> "Connections")
        const namePart = id.replace(/^\d+-/, '').replace(/-/g, ' ');
        // Capitalize Words
        const displayName = namePart.replace(/\b\w/g, l => l.toUpperCase());

        modules[id] = {
            id,
            displayName,
            setupFunc,
            isLoaded: false
        };

        // If app is already initialized, we might want to re-render sidebar, 
        // but typically registration happens before window load in our build.
    }

    function renderSidebar() {
        if (!sidebarNav) return;
        sidebarNav.innerHTML = '';

        // Icons map (simple SVGs for now)
        const icons = {
            '01-connections': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',
            '02-queue-discovery': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',
            '03-queue-browser': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
            '04-msg-publisher': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>',
            '05-msg-consumer': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>'
        };

        Object.values(modules).sort((a, b) => a.id.localeCompare(b.id)).forEach(mod => {
            const item = document.createElement('div');
            item.className = 'nav-item';
            item.dataset.moduleId = mod.id;

            const iconHtml = icons[mod.id] || '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';

            item.innerHTML = `
                <span class="nav-icon">${iconHtml}</span>
                <span class="nav-text">${mod.displayName}</span>
            `;

            item.onclick = () => loadModule(mod.id);
            // Tooltip for collapsed state
            item.title = mod.displayName;

            sidebarNav.appendChild(item);
        });
    }

    // Toggle Logic
    const mainSidebar = document.getElementById('main-sidebar');
    const btnToggle = document.getElementById('btn-sidebar-toggle');
    if (btnToggle && mainSidebar) {
        btnToggle.addEventListener('click', () => {
            mainSidebar.classList.toggle('collapsed');
        });
    }

    function ensureModuleRendered(id) {
        const mod = modules[id];
        if (!mod || mod.isLoaded) return;

        console.log(`First-time render for module: ${id}`);
        const tpl = document.getElementById(`module-tpl-${id}`);
        if (tpl && moduleContainer) {
            // Create a wrapper for the module
            const wrapper = document.createElement('div');
            wrapper.id = `module-view-${id}`;
            wrapper.className = 'module-view hidden'; // Start hidden
            wrapper.appendChild(document.importNode(tpl.content, true));
            moduleContainer.appendChild(wrapper);

            // Initialize Module Logic
            if (mod.setupFunc) {
                mod.setupFunc({
                    container: wrapper,
                    appState: state,
                    loadSelf: () => loadModule(id)
                });
            }
            mod.isLoaded = true;
        } else {
            console.error(`Template for module ${id} not found.`);
        }
    }

    function loadModule(id) {
        const mod = modules[id];
        if (!mod) return;

        console.log(`Activating module: ${id}`);
        state.activeModuleId = id;

        // Update Sidebar UI
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.toggle('active', el.dataset.moduleId === id);
        });

        // Update Title
        if (pageTitle) pageTitle.textContent = mod.displayName;

        // Ensure target is rendered
        ensureModuleRendered(id);

        // Toggle Visibility
        // Hide all module views
        const views = moduleContainer.querySelectorAll('.module-view');
        views.forEach(v => v.classList.add('hidden'));

        // Show target
        const targetView = document.getElementById(`module-view-${id}`);
        if (targetView) {
            targetView.classList.remove('hidden');
        }

        // Optional: Trigger an 'activate' event on the module if we wanted to support hooks
        // if (mod.onActivate) mod.onActivate();
    }

    // Expose public API
    return {
        VERSION: '2.0.0',
        init,
        registerModule,
        // Helpers for modules to access global state/services
        getState: () => state,
        config: window.APP_CONFIG || { useMocks: false }, // Default safe
        setState: (key, value) => {
            state[key] = value;
            updateGlobalUI();
            window.dispatchEvent(new CustomEvent('app:state-change', { detail: { key, value } }));
        },
        // Global Helper for SEMP Requests
        sempFetch: async (url, options = {}) => {
            const defaults = {
                headers: {}
            };

            // Auto-inject Basic Auth if connected
            if (state.sempCredentials) {
                const { user, pass } = state.sempCredentials;
                const token = btoa(`${user}:${pass}`);
                defaults.headers['Authorization'] = `Basic ${token}`;
            }

            const finalOptions = {
                ...options,
                headers: {
                    ...defaults.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, finalOptions);
                if (response.status === 401) {
                    // Invalid credentials -> Force Disconnect
                    console.warn('SEMP 401 Unauthorized - Terminating Connection');
                    state.isSempConnected = false;
                    state.sempCredentials = null;
                    updateGlobalUI();
                    window.dispatchEvent(new CustomEvent('semp:disconnected'));
                    window.dispatchEvent(new CustomEvent('app:state-change', { detail: { key: 'isSempConnected', value: false } }));
                }
                return response;
            } catch (err) {
                throw err;
            }
        },

        // Global Helper for Copying to Clipboard
        copyToClipboard: async (text, btnElement) => {
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);

                // Visual Feedback
                if (btnElement) {
                    const originalHtml = btnElement.innerHTML;
                    const originalWidth = btnElement.style.width; // Preserve width if needed, or rely on flex

                    btnElement.textContent = 'Copied!';
                    btnElement.classList.remove('btn-secondary'); // Assuming this class exists
                    btnElement.classList.add('btn-success');

                    setTimeout(() => {
                        btnElement.innerHTML = originalHtml;
                        btnElement.classList.remove('btn-success');
                        btnElement.classList.add('btn-secondary'); // Re-add default
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);
            }
        }
    };
})();

function updateGlobalUI() {
    const state = window.App.getState();
    const indClient = document.getElementById('status-indicator-client');
    const indSemp = document.getElementById('status-indicator-semp');

    if (indClient) {
        if (state.isConnected) indClient.classList.add('status-connected');
        else indClient.classList.remove('status-connected');
    }

    if (indSemp) {
        if (state.isSempConnected) indSemp.classList.add('status-connected');
        else indSemp.classList.remove('status-connected');
    }
}

// Bootstrap
window.addEventListener('DOMContentLoaded', () => {
    // Wait for BOTH Content Loaded AND Solace Library
    function doSafeInit() {
        // Version Check
        // Version Check handled by index.html loader
        const currentVersion = (window.solace && window.solace.Version.version) || '0.0.0';
        console.log(`Solace API Version (App Init): ${currentVersion}`); // Just log it

        window.App.init();
    }

    function tryInit() {
        if (window.solaceLibLoaded) {
            doSafeInit();
        } else {
            console.log('Waiting for Solace Library...');
            window.addEventListener('Solclient:loaded', () => {
                console.log('Solace Library Loaded Event Received -> Init App');
                doSafeInit();
            }, { once: true });
        }
    }

    tryInit();
});


// --- Modules ---

(function() {
    console.log('Initializing module: 01-connections');
    try {
        const moduleLogic = (function() {
            const moduleContainerId = '01-connections';
            
const config = {};

(function () {
    const STORAGE_KEY = 'solace_utility_config';

    config.load = function () {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                return JSON.parse(raw);
            }
        } catch (e) {
            console.error('Failed to load settings', e);
        }
        return null;
    };

    config.save = function (cfg) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
            return true;
        } catch (e) {
            console.error('Failed to save settings', e);
            throw e;
        }
    };
})();


const serviceSemp = {};

(function () {

    serviceSemp.connect = async function (cfg) {
        const els = ui.getElements();

        // Loading State
        els.btnSemp.disabled = true;
        els.btnSemp.innerHTML = '<span class="spinner">⌛</span> Connecting...';
        ui.showConnectError(els.elSempError, null);

        const baseUrl = `${cfg.protocol}://${cfg.host}:${cfg.port}`;
        const validationUrl = `${baseUrl}/SEMP/v2/config/msgVpns?count=1`;
        const authHeader = 'Basic ' + btoa(`${cfg.user}:${cfg.pass}`);

        try {
            // MOCK
            if (cfg.host.includes('untrust.com')) {
                throw new Error('Certificate Not Trusted (Mock)');
            }

            const res = await fetch(validationUrl, {
                method: 'GET',
                headers: { 'Authorization': authHeader }
            });

            if (res.ok) {
                console.log('SEMP Connection Established');

                // Update State
                window.App.setState('sempCredentials', { user: cfg.user, pass: cfg.pass, baseUrl });
                window.App.setState('isSempConnected', true);
                window.dispatchEvent(new CustomEvent('semp:connected'));

                // Update UI Local
                els.btnSemp.textContent = 'Disconnect';
                els.btnSemp.classList.remove('btn-primary');
                els.btnSemp.classList.add('btn-danger');

                ui.showError(els.elSempUser, false);
                ui.showError(els.elSempPass, false);

            } else if (res.status === 401) {
                console.error('SEMP Auth Failed');
                ui.showConnectError(els.elSempError, 'Authentication Failed (401). Check username/password.');
            } else {
                console.error(`SEMP Error: ${res.status}`);
                ui.showConnectError(els.elSempError, `SEMP Connection Failed: ${res.status} ${res.statusText}`);
            }

        } catch (err) {
            console.error('SEMP Network Error', err);

            let helpUrl = null;
            if (err.message && (err.message.includes('Failed to fetch') || err.message.includes('NetworkError'))) {
                helpUrl = `${cfg.protocol}://${cfg.host}:${cfg.port}`;
            }
            ui.showConnectError(els.elSempError, `SEMP Network Error: ${err.message}`, helpUrl);

        } finally {
            els.btnSemp.disabled = false;
            // Restore text if failed
            if (!window.App.getState().isSempConnected) {
                els.btnSemp.innerHTML = 'Connect'; // Restore HTML or Text
            } else {
                els.btnSemp.innerHTML = 'Disconnect';
            }
        }
    };

    serviceSemp.disconnect = function () {
        console.log('Disconnecting SEMP...');
        window.App.setState('isSempConnected', false);
        window.App.setState('sempCredentials', null);
        window.dispatchEvent(new CustomEvent('semp:disconnected'));

        const els = ui.getElements();
        if (els.btnSemp) {
            els.btnSemp.textContent = 'Connect';
            els.btnSemp.classList.remove('btn-danger');
            els.btnSemp.classList.add('btn-primary');
        }
    };

})();


const serviceSolace = {};

(function () {
    let session = null;
    let isInitialized = false;

    // CRITICAL: Factory Initialization called by index.js setup()
    serviceSolace.init = function () {
        if (isInitialized) return;
        if (!window.solace) {
            console.warn('Solace API not loaded yet.');
            return;
        }

        try {
            const factoryProps = new solace.SolclientFactoryProperties();
            factoryProps.profile = solace.SolclientFactoryProfiles.version10;
            factoryProps.logLevel = solace.LogLevel.WARN; // Can be adjusted
            solace.SolclientFactory.init(factoryProps);
            isInitialized = true;
            console.log('SolClientFactory Initialized.');
        } catch (e) {
            console.error('Failed to initialize SolClientFactory:', e);
        }
    };

    serviceSolace.connect = function (cfg) {
        if (session) {
            try { session.disconnect(); } catch (e) { }
        }

        if (!window.solace) {
            ui.showConnectError(ui.getElements().elSolError, 'Solace API not loaded.');
            return;
        }

        if (!isInitialized) serviceSolace.init(); // Just in case

        // Clear UI Errors via UI module
        const els = ui.getElements();
        ui.showConnectError(els.elSolError, null);
        ui.showFeedback(els.btnSolace, 'Connecting...'); // Feedback on button

        try {
            const props = new solace.SessionProperties();
            props.url = `${cfg.protocol}://${cfg.host}:${cfg.port}`;
            props.vpnName = cfg.vpn;
            props.userName = cfg.user;
            props.publisherProperties = { acknowledgeMode: solace.MessagePublisherAcknowledgeMode.PER_MESSAGE, };

            if (cfg.authMode === 'oauth') {
                props.authenticationScheme = solace.AuthenticationScheme.OAUTH2;
                props.accessToken = cfg.user; // Token in user field
                props.idToken = cfg.password; // Token in pass field
            } else {
                props.authenticationScheme = solace.AuthenticationScheme.BASIC;
                props.password = cfg.password;
            }

            // Advanced Props
            if (cfg.connectRetries !== undefined) props.connectRetries = cfg.connectRetries;
            if (cfg.connectTimeout !== undefined) props.connectTimeoutInMsecs = cfg.connectTimeout;
            if (cfg.reconnectRetries !== undefined) props.reconnectRetries = cfg.reconnectRetries;
            if (cfg.reconnectRetriesInMsecs !== undefined) props.reconnectRetryWaitInMsecs = cfg.reconnectWait;

            // MOCK: Simulate Untrusted
            // #MOCK_BEG
            if (cfg.host.includes('untrust.com')) {
                throw new Error('Certificate Not Trusted (Mock)');
            }
            // #MOCK_END

            console.log('Creating Session:', props);
            session = solace.SolclientFactory.createSession(props);
            window.App.session = session; // Global Ref

            // Event Listeners
            session.on(solace.SessionEventCode.UP_NOTICE, (sessionEvent) => {
                console.log('Solace Session UP');
                ui.showConnectError(els.elSolError, null);

                const btn = ui.getElements().btnSolace;
                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-danger');
                    btn.disabled = false;
                }

                // Global State & Events
                window.App.setState('isConnected', true);
                window.App.setState('selectedVpn', cfg.vpn);
                window.dispatchEvent(new CustomEvent('client:connected'));

                // Trigger UI Update directly via index -> which listens to event, but we can also trigger helper?
                // The event listener in index.js handles `ui.updateInputState()`.
            });

            session.on(solace.SessionEventCode.CONNECT_FAILED_ERROR, (sessionEvent) => {
                console.error('Connection Failed:', sessionEvent);

                let helpUrl = null;
                if (sessionEvent.infoStr && sessionEvent.infoStr.includes('Connection error')) {
                    // Try to guess Management URL based on current inputs?
                    // We need Semp settings... access via UI elements? 
                    // Better to rely on what was passed or access UI.
                    const sempEl = ui.getElements();
                    helpUrl = `${sempEl.elSempProtocol.value}://${cfg.host}:${sempEl.elSempPort.value}`;
                }

                ui.showConnectError(els.elSolError, `Connection Failed: ${sessionEvent.infoStr}`, helpUrl);
                serviceSolace.cleanup();
            });

            session.on(solace.SessionEventCode.DISCONNECTED, (sessionEvent) => {
                console.log('Disconnected');
                serviceSolace.cleanup();
                window.dispatchEvent(new CustomEvent('client:disconnected'));
            });

            // Global Event Dispatching for ACK/REJECT (Forwarding Support)
            session.on(solace.SessionEventCode.ACKNOWLEDGED_MESSAGE, (sessionEvent) => {
                window.dispatchEvent(new CustomEvent('client:session-ack', { detail: sessionEvent }));
            });
            session.on(solace.SessionEventCode.REJECTED_MESSAGE_ERROR, (sessionEvent) => {
                window.dispatchEvent(new CustomEvent('client:session-reject', { detail: sessionEvent }));
            });

            // Other events...
            session.on(solace.SessionEventCode.MESSAGE, (message) => {
                // Generic handler
            });

            session.connect();

        } catch (e) {
            console.error('Session Creation Error', e);

            // Mock Help URL Check
            let helpUrl = null;
            if (e.message && e.message.includes('Certificate')) {
                const sempEl = ui.getElements();
                helpUrl = `${sempEl.elSempProtocol.value}://${cfg.host}:${sempEl.elSempPort.value}`;
            }

            ui.showConnectError(els.elSolError, e.message, helpUrl);
            serviceSolace.cleanup();
        }
    };

    serviceSolace.disconnect = function () {
        if (session) {
            try { session.disconnect(); } catch (e) { }
        } else {
            serviceSolace.cleanup();
        }
    };

    serviceSolace.cleanup = function () {
        const els = ui.getElements();
        if (els.btnSolace) {
            els.btnSolace.textContent = 'Connect';
            els.btnSolace.classList.remove('btn-danger');
            els.btnSolace.classList.add('btn-primary');
            els.btnSolace.disabled = false;
        }

        window.App.setState('isConnected', false);
        window.App.setState('selectedVpn', null);

        if (window.App.session) {
            try { window.App.session.dispose(); } catch (e) { }
            window.App.session = null;
        }
        session = null;
    };

})();


const ui = {};

(function () {
    let elements = {};

    ui.getElements = function () {
        if (elements.container) return elements;

        // Locate container manually if not set (fallback)
        // Usually setup() calls cacheElements first
        const c = document.getElementById('module-container');
        if (c) ui.cacheElements(c);
        return elements;
    };

    ui.cacheElements = function (container) {
        elements.container = container;

        // Broker Inputs
        elements.elHost = container.querySelector('#conn-host');
        elements.btnSave = container.querySelector('#btn-save-config');
        elements.btnLoad = container.querySelector('#btn-load-config');
        elements.btnReset = container.querySelector('#btn-reset-form');

        // Solace Inputs
        elements.elSolProtocol = container.querySelector('#solace-protocol');
        elements.elSolPort = container.querySelector('#solace-port');
        elements.elSolVpn = container.querySelector('#solace-vpn');
        elements.elSolUser = container.querySelector('#solace-username');
        elements.elSolPass = container.querySelector('#solace-password');
        elements.btnSolace = container.querySelector('#btn-solace-connect');
        elements.radiosAuth = container.querySelectorAll('input[name="solace-auth-mode"]');
        elements.lblSolUser = container.querySelector('#lbl-solace-username');
        elements.lblSolPass = container.querySelector('#lbl-solace-password');

        // SEMP Inputs
        elements.elSempProtocol = container.querySelector('#semp-protocol');
        elements.elSempPort = container.querySelector('#semp-port');
        elements.elSempUser = container.querySelector('#semp-username');
        elements.elSempPass = container.querySelector('#semp-password');
        elements.btnSemp = container.querySelector('#btn-semp-connect');

        // Feedback
        elements.elSolError = container.querySelector('#solace-connect-error');
        elements.elSempError = container.querySelector('#semp-connect-error');

        // Advanced
        elements.btnSettings = container.querySelector('#btn-solace-settings');
        elements.elSettingsModal = container.querySelector('#solace-settings-modal');
        elements.btnCloseSettings = container.querySelector('#btn-cancel-settings');
        elements.elConnectRetries = container.querySelector('#sol-connect-retries');
        elements.elConnectTimeout = container.querySelector('#sol-connect-timeout');
        elements.elReconnectRetries = container.querySelector('#sol-reconnect-retries');
        elements.elReconnectWait = container.querySelector('#sol-reconnect-wait');

        // SSL Modal
        elements.elSslModal = container.querySelector('#ssl-trust-modal');
        elements.elSslLink = container.querySelector('#ssl-trust-link');
        elements.elSslUrlText = container.querySelector('#ssl-trust-url-text');
        elements.btnCloseSsl = container.querySelector('#btn-close-ssl-modal');
    };

    ui.initEvents = function () {
        const els = elements;
        // Settings Modal
        if (els.btnSettings) {
            els.btnSettings.addEventListener('click', () => els.elSettingsModal.classList.remove('hidden'));
        }
        if (els.btnCloseSettings) {
            els.btnCloseSettings.addEventListener('click', () => els.elSettingsModal.classList.add('hidden'));
        }
        // SSL Modal
        if (els.btnCloseSsl) {
            els.btnCloseSsl.addEventListener('click', () => els.elSslModal.classList.add('hidden'));
        }
        // Auth Toggle
        if (els.radiosAuth) {
            els.radiosAuth.forEach(r => r.addEventListener('change', ui.updateAuthUI));
        }
    };

    ui.showConnectError = function (el, msg, helpUrl) {
        if (msg) {
            el.textContent = msg;
            el.className = 'invalid-feedback';
            el.style.display = 'block';
            el.style.color = 'var(--status-error)';

            if (helpUrl) {
                const span = document.createElement('span');
                span.textContent = ' ⚠️ ';
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = 'Trust Certificate?';
                link.className = 'error-help-link';
                link.style.marginLeft = '0.25rem';
                link.style.color = 'var(--status-error)';
                link.style.fontWeight = 'bold';
                link.style.textDecoration = 'underline';
                link.title = 'Open broker URL to manually accept certificate';

                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    ui.openSslModal(helpUrl);
                });

                el.appendChild(span);
                el.appendChild(link);
            }
        } else {
            el.textContent = '';
            el.style.display = 'none';
        }
    };

    ui.showError = function (el, show) {
        if (show) el.classList.add('is-invalid');
        else el.classList.remove('is-invalid');
    };

    ui.showFeedback = function (btn, text) {
        if (btn) btn.textContent = text;
    };

    ui.openSslModal = function (url) {
        const els = elements;
        if (els.elSslLink) els.elSslLink.href = url;
        if (els.elSslUrlText) els.elSslUrlText.textContent = url;
        if (els.elSslModal) els.elSslModal.classList.remove('hidden');
    };

    ui.getAuthMode = function () {
        const els = elements;
        if (!els.radiosAuth) return 'basic';
        for (const r of els.radiosAuth) {
            if (r.checked) return r.value;
        }
        return 'basic';
    };

    ui.setAuthMode = function (mode) {
        const els = elements;
        if (!els.radiosAuth) return;
        for (const r of els.radiosAuth) {
            if (r.value === mode) r.checked = true;
        }
        ui.updateAuthUI();
    };

    ui.updateAuthUI = function () {
        const els = elements;
        const mode = ui.getAuthMode();
        if (mode === 'oauth') {
            els.lblSolUser.textContent = 'Access Token';
            els.lblSolPass.textContent = 'ID Token';
            els.elSolUser.placeholder = 'Access Token';
        } else {
            els.lblSolUser.textContent = 'Username';
            els.lblSolPass.textContent = 'Password';
            els.elSolUser.placeholder = 'default';
        }
    };

    // CRITICAL: Matches global state logic to disable inputs
    ui.updateInputState = function () {
        const state = window.App.getState();
        const isSempConnected = state.isSempConnected;
        const isSolaceConnected = state.isConnected; // Global prop
        const els = elements;

        const anyConnected = isSolaceConnected || isSempConnected;
        if (els.elHost) els.elHost.disabled = anyConnected;

        // Solace Fields
        if (els.elSolProtocol) els.elSolProtocol.disabled = isSolaceConnected;
        if (els.elSolPort) els.elSolPort.disabled = isSolaceConnected;
        if (els.elSolVpn) els.elSolVpn.disabled = isSolaceConnected;
        if (els.elSolUser) els.elSolUser.disabled = isSolaceConnected;
        if (els.elSolPass) els.elSolPass.disabled = isSolaceConnected;
        if (els.radiosAuth) els.radiosAuth.forEach(r => r.disabled = isSolaceConnected);
        if (els.btnSettings) els.btnSettings.disabled = isSolaceConnected;

        // SEMP Fields
        if (els.elSempUser) els.elSempUser.disabled = isSempConnected;
        if (els.elSempPass) els.elSempPass.disabled = isSempConnected;
        if (els.elSempProtocol) els.elSempProtocol.disabled = isSempConnected;
        if (els.elSempPort) els.elSempPort.disabled = isSempConnected;
    };

    // Helpers
    ui.isValidHost = function (val) {
        const re = /^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$|^(\d{1,3}\.){3}\d{1,3}$/;
        return val && re.test(val);
    };

    ui.isValidPort = function (val) {
        const p = parseInt(val, 10);
        return !isNaN(p) && p > 0 && p <= 65535;
    };

})();


function setup(context) {
    const { container, appState, loadSelf } = context;

    // 1. Initialize UI (Cache Elements)
    ui.cacheElements(container);
    ui.initEvents();
    const els = ui.getElements();

    // ... (rest of setup)

    // 2. Initialize Solace Factory (Critical: Must happen after solclient.js loads)
    serviceSolace.init();

    // Helper: Apply Config to UI
    function applyConfig(cfg) {
        if (!cfg) return;

        if (cfg.host) els.elHost.value = cfg.host;

        if (cfg.solace) {
            if (cfg.solace.protocol) els.elSolProtocol.value = cfg.solace.protocol;
            if (cfg.solace.port) els.elSolPort.value = cfg.solace.port;
            if (cfg.solace.vpn) els.elSolVpn.value = cfg.solace.vpn;
            if (cfg.solace.user) els.elSolUser.value = cfg.solace.user;
            if (cfg.solace.authMode) ui.setAuthMode(cfg.solace.authMode);

            // Advanced
            if (cfg.solace.connectRetries !== undefined) els.elConnectRetries.value = cfg.solace.connectRetries;
            if (cfg.solace.connectTimeout !== undefined) els.elConnectTimeout.value = cfg.solace.connectTimeout;
            if (cfg.solace.reconnectRetries !== undefined) els.elReconnectRetries.value = cfg.solace.reconnectRetries;
            if (cfg.solace.reconnectWait !== undefined) els.elReconnectWait.value = cfg.solace.reconnectWait;
        }

        if (cfg.semp) {
            if (cfg.semp.protocol) els.elSempProtocol.value = cfg.semp.protocol;
            if (cfg.semp.port) els.elSempPort.value = cfg.semp.port;
            if (cfg.semp.user) els.elSempUser.value = cfg.semp.user;
        }
    }

    // 3. Load Saved Settings (Initial)
    const cfg = config.load();
    if (cfg) {
        applyConfig(cfg);
        console.log('Settings loaded via config.js');
    }

    // 4. Wire Click Handlers

    // Save
    if (els.btnSave) {
        els.btnSave.addEventListener('click', () => {
            const newCfg = {
                host: els.elHost.value,
                solace: {
                    protocol: els.elSolProtocol.value,
                    port: els.elSolPort.value,
                    vpn: els.elSolVpn.value,
                    user: els.elSolUser.value,
                    authMode: ui.getAuthMode(),
                    connectRetries: parseInt(els.elConnectRetries.value, 10),
                    connectTimeout: parseInt(els.elConnectTimeout.value, 10),
                    reconnectRetries: parseInt(els.elReconnectRetries.value, 10),
                    reconnectWait: parseInt(els.elReconnectWait.value, 10)
                },
                semp: {
                    protocol: els.elSempProtocol.value,
                    port: els.elSempPort.value,
                    user: els.elSempUser.value
                }
            };
            if (config.save(newCfg)) {
                ui.showFeedback(els.btnSave, 'Saved!');
                setTimeout(() => ui.showFeedback(els.btnSave, 'Save Config'), 2000);
            }
        });
    }

    // Load
    if (els.btnLoad) {
        els.btnLoad.addEventListener('click', () => {
            const c = config.load();
            if (c) {
                applyConfig(c);
                ui.showFeedback(els.btnLoad, 'Loaded!');
                setTimeout(() => ui.showFeedback(els.btnLoad, 'Load Config'), 1500);
            }
        });
    }

    // Reset
    if (els.btnReset) {
        els.btnReset.addEventListener('click', () => {
            // Confirm? Maybe not strictly needed for a local form reset, but good practice if complex. 
            // For now, just reset as requested.

            // Clear Inputs
            if (els.elHost) els.elHost.value = '';

            // Solace
            if (els.elSolProtocol) els.elSolProtocol.value = 'wss'; // Default
            if (els.elSolPort) els.elSolPort.value = '';
            if (els.elSolVpn) els.elSolVpn.value = '';
            if (els.elSolUser) els.elSolUser.value = '';
            if (els.elSolPass) els.elSolPass.value = '';
            ui.setAuthMode('basic');

            // SEMP
            if (els.elSempProtocol) els.elSempProtocol.value = 'https'; // Default
            if (els.elSempPort) els.elSempPort.value = '';
            if (els.elSempUser) els.elSempUser.value = '';
            if (els.elSempPass) els.elSempPass.value = '';

            // Clear Errors
            [els.elHost, els.elSolPort, els.elSolVpn, els.elSolUser, els.elSempPort, els.elSempUser, els.elSempPass]
                .forEach(el => {
                    if (el) ui.showError(el, false);
                });

            ui.showFeedback(els.btnReset, 'Reset!');
            setTimeout(() => ui.showFeedback(els.btnReset, 'Reset Form'), 1500);
        });
    }

    // Validate Helper
    function validateSolace() {
        let valid = true;
        if (!ui.isValidHost(els.elHost.value)) { ui.showError(els.elHost, true); valid = false; } else ui.showError(els.elHost, false);
        if (!ui.isValidPort(els.elSolPort.value)) { ui.showError(els.elSolPort, true); valid = false; } else ui.showError(els.elSolPort, false);
        if (!els.elSolVpn.value.trim()) { ui.showError(els.elSolVpn, true); valid = false; } else ui.showError(els.elSolVpn, false);
        if (!els.elSolUser.value.trim()) { ui.showError(els.elSolUser, true); valid = false; } else ui.showError(els.elSolUser, false);
        return valid;
    }

    function validateSemp() {
        let valid = true;
        if (!ui.isValidHost(els.elHost.value)) { ui.showError(els.elHost, true); valid = false; } else ui.showError(els.elHost, false);
        if (!ui.isValidPort(els.elSempPort.value)) { ui.showError(els.elSempPort, true); valid = false; } else ui.showError(els.elSempPort, false);
        if (!els.elSempUser.value.trim()) { ui.showError(els.elSempUser, true); valid = false; } else ui.showError(els.elSempUser, false);
        if (!els.elSempPass.value.trim()) { ui.showError(els.elSempPass, true); valid = false; } else ui.showError(els.elSempPass, false);
        return valid;
    }

    // Connect Solace
    if (els.btnSolace) {
        els.btnSolace.addEventListener('click', () => {
            if (window.App.getState().isConnected) {
                serviceSolace.disconnect();
            } else {
                if (!validateSolace()) return;
                serviceSolace.connect({
                    protocol: els.elSolProtocol.value,
                    host: els.elHost.value,
                    port: els.elSolPort.value,
                    vpn: els.elSolVpn.value,
                    user: els.elSolUser.value,
                    password: els.elSolPass.value,
                    authMode: ui.getAuthMode(),
                    connectRetries: parseInt(els.elConnectRetries.value, 10),
                    connectTimeout: parseInt(els.elConnectTimeout.value, 10),
                    reconnectRetries: parseInt(els.elReconnectRetries.value, 10),
                    reconnectWait: parseInt(els.elReconnectWait.value, 10)
                });
            }
        });
    }

    // Helper: Trigger on Enter
    function onEnter(e, btn) {
        if (e.key === 'Enter') {
            e.preventDefault();
            btn.click();
        }
    }

    // Solace Inputs -> Enter triggers Solace Connect
    [els.elHost, els.elSolPort, els.elSolVpn, els.elSolUser, els.elSolPass].forEach(input => {
        if (input) input.addEventListener('keypress', (e) => onEnter(e, els.btnSolace));
    });

    // SEMP Inputs -> Enter triggers SEMP Connect
    // Note: elHost is shared, so logic might be tricky if user intends SEMP but focused on Host. 
    // Usually Host + SempPort implies Semp. But Host + SolPort implies Solace.
    // If I press Enter on Host, which one connects? 
    // DEFAULT: Host usually implies Solace (Primary). 
    // Explicit SEMP inputs trigger SEMP.
    [els.elSempPort, els.elSempUser, els.elSempPass].forEach(input => {
        if (input) input.addEventListener('keypress', (e) => onEnter(e, els.btnSemp));
    });

    // Connect SEMP
    if (els.btnSemp) {
        els.btnSemp.addEventListener('click', () => {
            if (window.App.getState().isSempConnected) {
                serviceSemp.disconnect();
            } else {
                if (!validateSemp()) return;
                serviceSemp.connect({
                    protocol: els.elSempProtocol.value,
                    host: els.elHost.value,
                    port: els.elSempPort.value,
                    user: els.elSempUser.value,
                    pass: els.elSempPass.value
                });
            }
        });
    }

    // Listen for Global Events to Update UI State
    ['client:connected', 'client:disconnected', 'semp:connected', 'semp:disconnected'].forEach(evt => {
        window.addEventListener(evt, () => {
            console.log(`Global Event received: ${evt} -> Updating Input State`);
            ui.updateInputState();
        });
    });


    // Initial State Check
    ui.updateInputState();

    // Cross-Module: Handle "Open in Browser" request
    window.addEventListener('connection:check-connection', (e) => {
        console.log('[Connections] Received Open Request:', e.detail);
        const targetVpn = e.detail.vpn;
        const targetQueue = e.detail.queue;

        // 1. Switch View to Connections
        if (loadSelf) {
            loadSelf();
        } else {
            const navItem = document.querySelector('.nav-item[data-module-id="01-connections"]');
            if (navItem) navItem.click();
        }

        // 2. Helper to finish
        const finish = () => {
            console.log('[Connections] Connection Ready. Requesting Browse...');
            window.dispatchEvent(new CustomEvent('browser:browse-queue', {
                detail: { queue: targetQueue }
            }));
        };

        const appState = window.App.getState();

        // 3. Logic
        if (!appState.isConnected) {
            // Case A: Not Connected -> Set VPN & Connect
            console.log('[Connections] Not connected. Auto-connecting...');
            els.elSolVpn.value = targetVpn;

            // Listen for success (once)
            const onSuccess = () => {
                finish();
                window.removeEventListener('client:connected', onSuccess);
            };
            window.addEventListener('client:connected', onSuccess);

            // Trigger Connect
            els.btnSolace.click();

        } else {
            // Case B: Connected -> Check VPN
            // We use the input value OR the connected state. 
            // els.elSolVpn.value "should" match connected VPN if UI is synced, 
            // but let's check what the User *sees* vs what is connected.
            // Ideally check internal config, but `els.elSolVpn.value` is what sends the connect.
            if (els.elSolVpn.value === targetVpn) {
                // Match -> Go
                finish();
            } else {
                // Mismatch -> Prompt
                const doSwitch = confirm(`Current VPN is "${els.elSolVpn.value}". Switch to "${targetVpn}" to browse queue?`);
                if (doSwitch) {
                    console.log('[Connections] Switching VPN...');
                    // Disconnect
                    if (serviceSolace && serviceSolace.disconnect) serviceSolace.disconnect();

                    // Update Value
                    els.elSolVpn.value = targetVpn;

                    // Wait small tick for disconnect cleanup if needed, or just connect
                    setTimeout(() => {
                        // Listen for success (once)
                        const onSuccess = () => {
                            finish();
                            window.removeEventListener('client:connected', onSuccess);
                        };
                        window.addEventListener('client:connected', onSuccess);

                        // Trigger Connect
                        els.btnSolace.click();
                    }, 500);
                } else {
                    console.log('[Connections] Switch cancelled.');
                }
            }
        }
    });

    console.log('Connections Module Setup Complete (Refactored)');
}

            // Explicitly return the exported setup function if it exists
            return typeof setup === 'function' ? setup : null;
        })();

        if (window.App && window.App.registerModule) {
            window.App.registerModule('01-connections', moduleLogic);
        }
    } catch (e) {
        console.error('Failed to load module 01-connections', e);
    }
})();


(function() {
    console.log('Initializing module: 02-queue-discovery');
    try {
        const moduleLogic = (function() {
            const moduleContainerId = '02-queue-discovery';
            
function setup(context) {
    const { container, appState } = context;

    const elWarning = container.querySelector('#discovery-warning');
    const elContent = container.querySelector('#discovery-content');

    // VPN Elements
    const vpnInput = container.querySelector('#discovery-vpn-input');
    const vpnList = container.querySelector('#discovery-vpn-list');
    const btnRefreshVpns = container.querySelector('#btn-refresh-vpns');

    // Queue Elements
    const queueInput = container.querySelector('#discovery-queue-input');
    const queueList = container.querySelector('#discovery-queue-list');
    const btnRefreshQueues = container.querySelector('#btn-refresh-queues');
    const btnCopy = container.querySelector('#btn-copy-config');

    // State
    // State
    // #MOCK_BEG
    const mockVpns = ['default', 'vpn-dev', 'vpn-prod', 'vpn-test-1', 'vpn-test-2', 'vpn-finance'];
    const mockQueues = ['Q/ORDER/NEW', 'Q/ORDER/PROCESS', 'Q/LOGS/AUDIT', 'Q/PAYMENT/INIT', 'Q/PAYMENT/ACK'];
    // #MOCK_END
    let selectedVpn = null;
    let selectedQueue = null;

    // Available lists for validation
    let currentVpnList = [];
    let currentQueueList = [];

    // --- Searchable Dropdown Helper ---
    function setupSearchableSelect(inputEl, listEl, onSelectCallback) {
        // Filter Logic
        inputEl.addEventListener('input', () => {
            const term = inputEl.value.toLowerCase();
            const options = listEl.querySelectorAll('.dropdown-option');
            let hasVisible = false;
            options.forEach(opt => {
                const text = opt.textContent.toLowerCase();
                if (text.includes(term)) {
                    opt.style.display = 'block';
                    hasVisible = true;
                } else {
                    opt.style.display = 'none';
                }
            });
            listEl.classList.add('show');
        });

        // Show on focus
        inputEl.addEventListener('focus', () => {
            if (inputEl.value === '') {
                listEl.querySelectorAll('.dropdown-option').forEach(o => o.style.display = 'block');
            }
            listEl.classList.add('show');
        });

        // Hide on outside click
        document.addEventListener('click', (e) => {
            if (!inputEl.contains(e.target) && !listEl.contains(e.target)) {
                listEl.classList.remove('show');
            }
        });
    }

    function renderOptions(listEl, items, onSelect) {
        listEl.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'dropdown-option';
            empty.textContent = 'No items found';
            empty.style.fontStyle = 'italic';
            listEl.appendChild(empty);
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'dropdown-option';
            div.textContent = item;
            div.addEventListener('click', () => {
                onSelect(item);
                listEl.classList.remove('show');
            });
            listEl.appendChild(div);
        });
    }

    // --- Logic ---

    function handleVpnSelect(vpn) {
        selectedVpn = vpn;
        vpnInput.value = vpn;
        console.log(`VPN Selected: ${vpn}`);

        // Update Global State
        if (window.App && window.App.setState) {
            window.App.setState('selectedVpn', vpn);
        }

        fetchQueues(); // Auto-fetch queues
    }

    function handleQueueSelect(queue) {
        selectedQueue = queue;
        queueInput.value = queue;
        console.log(`Queue Selected: ${queue}`);
        if (btnCopy) btnCopy.disabled = false;
    }

    async function fetchVpns() {
        console.log('Fetching VPNs...');
        vpnInput.placeholder = 'Loading...';

        // Mock Fallback if configured (or if we want to support both)
        // For now, if sempConnected, use real.
        const state = window.App.getState();

        // #MOCK_BEG
        if (window.App.config.useMocks) {
            console.log('Using Mock VPNs');
            currentVpnList = mockVpns;
            renderOptions(vpnList, mockVpns, handleVpnSelect);
            vpnInput.placeholder = 'Select a Message VPN (Mock)';
            return;
        }
        // #MOCK_END

        if (!state.isSempConnected) {
            // Fallback or just empty
            vpnInput.placeholder = 'SEMP Not Connected';
            return;
        }

        const { baseUrl } = state.sempCredentials;
        const url = `${baseUrl}/SEMP/v2/monitor/msgVpns?count=100`; // Limit 100 for now

        try {
            const res = await window.App.sempFetch(url);
            if (res.ok) {
                const data = await res.json();
                if (data.data) {
                    const vpnNames = data.data.map(v => v.msgVpnName).sort();
                    currentVpnList = vpnNames;
                    renderOptions(vpnList, vpnNames, handleVpnSelect);

                    vpnInput.placeholder = 'Select a Message VPN';

                    // Auto-select first if available and nothing selected
                    if (vpnNames.length > 0 && !selectedVpn) {
                        // Optional: Auto select default? Or just first?
                        // User didn't strictly ask for auto-select, but "populate the vpn list".
                        // I will just populate for now to be safe, or maybe select "default" if exists?
                        // Let's just ready the list.
                        if (vpnNames.includes('default')) {
                            // handleVpnSelect('default'); // Maybe too aggressive?
                        }
                    }
                }
            } else {
                console.error('Failed to fetch VPNs', res.statusText);
                vpnInput.placeholder = 'Error fetching VPNs';
            }
        } catch (e) {
            console.error('Error fetching VPNs', e);
            vpnInput.placeholder = 'Network Error';
        }
    }

    async function fetchQueues() {
        if (!selectedVpn) {
            queueInput.disabled = true;
            queueInput.value = '';
            if (btnCopy) btnCopy.disabled = true;
            return;
        }

        console.log(`Fetching Queues for ${selectedVpn}...`);
        queueInput.placeholder = 'Loading...';
        queueInput.value = ''; // Reset queue selection
        selectedQueue = null;
        if (btnCopy) btnCopy.disabled = true;

        renderOptions(queueList, [], handleQueueSelect);

        const state = window.App.getState();

        // #MOCK_BEG
        if (window.App.config.useMocks) {
            console.log('Using Mock Queues');
            currentQueueList = mockQueues;
            queueInput.disabled = false;
            queueInput.placeholder = 'Select a Queue (Mock)';
            renderOptions(queueList, mockQueues, handleQueueSelect);
            return;
        }
        // #MOCK_END

        if (!state.isSempConnected) {
            queueInput.placeholder = 'SEMP Not Connected';
            return;
        }

        const { baseUrl } = state.sempCredentials;
        // Monitor endpoint for queues
        const url = `${baseUrl}/SEMP/v2/monitor/msgVpns/${selectedVpn}/queues?count=100`;

        try {
            const res = await window.App.sempFetch(url);
            if (res.ok) {
                const data = await res.json();
                if (data.data) {
                    const queueNames = data.data.map(q => q.queueName).sort();
                    currentQueueList = queueNames;

                    if (queueNames.length === 0) {
                        queueInput.value = 'No queues in Message VPN';
                        queueInput.disabled = true;
                        renderOptions(queueList, [], handleQueueSelect);
                    } else {
                        queueInput.disabled = false;
                        queueInput.placeholder = 'Select a Queue';
                        renderOptions(queueList, queueNames, handleQueueSelect);
                    }
                }
            } else {
                console.error('Failed to fetch Queues', res.statusText);
                queueInput.placeholder = 'Error fetching Queues';
            }
        } catch (e) {
            console.error('Error fetching Queues', e);
            queueInput.placeholder = 'Network Error';
        }
    }

    function updateVisibility(isConnected) {
        if (!isConnected) {
            if (elWarning) elWarning.classList.remove('hidden');
            if (elContent) elContent.classList.add('hidden');
        } else {
            if (elWarning) elWarning.classList.add('hidden');
            if (elContent) elContent.classList.remove('hidden');
        }
    }

    // Setup Components
    setupSearchableSelect(vpnInput, vpnList, handleVpnSelect);
    setupSearchableSelect(queueInput, queueList, handleQueueSelect);

    // Initial State
    queueInput.disabled = true; // Disabled until VPN selected

    // Blur Validation for VPN
    vpnInput.addEventListener('blur', () => {
        setTimeout(() => {
            const val = vpnInput.value;
            // Validate against list
            if (val && !currentVpnList.includes(val)) {
                console.log('Invalid VPN entered. Clearing.');
                vpnInput.value = '';
                selectedVpn = null;

                // Cascade Effect: Reset Queue
                queueInput.value = '';
                queueInput.disabled = true;
                selectedQueue = null;
                if (btnCopy) btnCopy.disabled = true;
            } else if (!val) {
                // Also handle empty
                selectedVpn = null;
                queueInput.value = '';
                queueInput.disabled = true;
                if (btnCopy) btnCopy.disabled = true;
            }
        }, 150);
    });

    // Blur Validation for Queues
    queueInput.addEventListener('blur', () => {
        // Small delay to allow click on option to register first
        setTimeout(() => {
            if (queueInput.disabled) return;

            const val = queueInput.value;
            // If value is not in the list of valid queues
            // (Only checks strict match; could be case-insensitive if desired, but user said "valid names")
            if (val && !currentQueueList.includes(val)) {
                console.log('Invalid queue entered. Clearing.');
                queueInput.value = '';
                selectedQueue = null;
                btnCopy.disabled = true;
            }
        }, 150);
    });

    // Initial State Check
    updateVisibility(appState.isSempConnected);
    if (appState.isSempConnected) {
        fetchVpns();
    }

    function clearAll() {
        // Clear VPNs
        vpnInput.value = '';
        selectedVpn = null;
        currentVpnList = [];

        // Clear Queues
        queueInput.value = '';
        queueInput.disabled = true;
        selectedQueue = null;
        currentQueueList = [];
        if (btnCopy) btnCopy.disabled = true;

        renderOptions(vpnList, [], handleVpnSelect);
        renderOptions(queueList, [], handleQueueSelect);
    }

    // Event Listeners
    btnRefreshVpns.addEventListener('click', () => {
        clearAll();
        fetchVpns();
    });

    btnRefreshQueues.addEventListener('click', () => {
        if (!selectedVpn) return;

        // Clear Queues
        queueInput.value = '';
        selectedQueue = null;
        currentQueueList = [];
        if (btnCopy) btnCopy.disabled = true;

        renderOptions(queueList, [], handleQueueSelect);

        fetchQueues();
    });

    if (btnCopy) {
        btnCopy.addEventListener('click', () => {
            if (selectedVpn && selectedQueue) {
                // Emit Cross-Module Event
                console.log(`[Discovery] Requesting Open in Browser: VPN=${selectedVpn}, Queue=${selectedQueue}`);
                window.dispatchEvent(new CustomEvent('connection:check-connection', {
                    detail: {
                        vpn: selectedVpn,
                        queue: selectedQueue
                    }
                }));
            } else {
                alert('Please select a VPN and Queue first.');
            }
        });
    }

    // Enter Key Support
    vpnInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            btnRefreshVpns.click();
        }
    });

    queueInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            btnRefreshQueues.click();
        }
    });

    // Global State Listener
    window.addEventListener('app:state-change', (e) => {
        if (e.detail.key === 'isSempConnected') {
            const isConnected = e.detail.value;
            updateVisibility(isConnected);
            if (isConnected) {
                fetchVpns();
            } else {
                clearAll();
            }
        }
    });
}

            // Explicitly return the exported setup function if it exists
            return typeof setup === 'function' ? setup : null;
        })();

        if (window.App && window.App.registerModule) {
            window.App.registerModule('02-queue-discovery', moduleLogic);
        }
    } catch (e) {
        console.error('Failed to load module 02-queue-discovery', e);
    }
})();


(function() {
    console.log('Initializing module: 03-queue-browser');
    try {
        const moduleLogic = (function() {
            const moduleContainerId = '03-queue-browser';
            
const icons = {
    downloadContent: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
    downloadFull: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M10 12h.01"></path><path d="M14 12h.01"></path><path d="M10 16h.01"></path><path d="M14 16h.01"></path></svg>',
    forward: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 17 20 12 15 7"></polyline><path d="M4 18v-2a4 4 0 0 1 4-4h12"></path></svg>',
    delete: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
    copy: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'
};

// #MOCK_BEG
const staticMessages = [
    { id: 'msg_10234', date: '2023-10-27 10:30:01', size: '1.2 KB', type: 'TextMessage', headers: '{"JMS_Solace_DeadMsgQueueEligible": true, "SenderID": "App_A"}', content: '{"orderId": "1001", "status": "PENDING"}' },
    { id: 'msg_10235', date: '2023-10-27 10:30:05', size: '512 B', type: 'BytesMessage', headers: '{"SenderID": "IoT_Device_1"}', content: '<binary data>' },
    { id: 'msg_10236', date: '2023-10-27 10:31:12', size: '2.0 KB', type: 'TextMessage', headers: '{"JMS_CorrelationID": "req_999"}', content: '{"orderId": "1002", "status": "APPROVED"}' },
    { id: 'msg_10237', date: '2023-10-27 10:32:00', size: '800 B', type: 'TextMessage', headers: '{"ErrorSource": "Validator"}', content: '{"log": "ERROR", "code": 500}' },
    { id: 'msg_10238', date: '2023-10-27 10:35:00', size: '1.5 KB', type: 'TextMessage', headers: '{"Priority": 9}', content: '{"orderId": "1003", "status": "PENDING"}' },
];

function generateMockMessages(count) {
    const msgs = [];
    for (let i = 0; i < count; i++) {
        msgs.push({
            id: `msg_test_${1000 + i}`,
            date: new Date().toLocaleString(),
            size: Math.floor(Math.random() * 5) + 1 + ' KB',
            type: 'TextMessage',
            headers: `{"TestIndex": ${i}, "Generated": true}`,
            content: `{"data": "Test Message ${i}", "timestamp": ${Date.now()}}`
        });
    }
    return msgs;
}
// #MOCK_END


// import state, { addMessage, getMessages } from './state.js';
// import * as ui from './ui.js';

const serviceEvents = {};

serviceEvents.onBrowserUp = function (queueName) {
    console.log(`[${queueName}] Browser UP`);

    // Finalize Bind in UI
    ui.addQueueToDropdown(queueName);

    // Clear Input on success if matching
    const els = ui.getElements();
    if (els.inputBind && els.inputBind.value.trim() === queueName) {
        els.inputBind.value = '';
    }

    if (state.currentQueue === queueName) {
        ui.showBrowserError(null);
        // Duplicate call removed - handled by dropdown change event
    }
}

serviceEvents.onConnectFailed = function (queueName, err) {
    console.error(`[${queueName}] Connect Failed:`, err);

    // Show Inline Error for binding
    ui.showBindError(`Connection Failed: ${err.message || 'Unknown Error'}`);

    // If active view
    if (state.currentQueue === queueName) {
        ui.showBrowserError(`Connection Failed: ${err.message || 'Unknown Error'}`);
    }

    // Cleanup browser instance so it can be retried
    if (service.disconnectBrowser) {
        service.disconnectBrowser(queueName);
    }
}

serviceEvents.onBrowserDown = function (queueName, err) {
    console.error(`[${queueName}] Browser Down:`, err);
    if (state.currentQueue === queueName) {
        ui.showBrowserError(`Browser connection error: ${err.message || err}`);
    }
}

// Session Events (for Forwarding)
serviceEvents.onSessionAck = function (sessionEvent) {
    if (sessionEvent && sessionEvent["correlationKey"] && sessionEvent["correlationKey"]["Solace_Msg_Utility_Seq_Num"]) {
        const seqNum = sessionEvent["correlationKey"]["Solace_Msg_Utility_Seq_Num"];
        console.log(`ACK Received for ${seqNum}`);
        ui.updateForwardItemStatus(seqNum, 'SUCCESS');
        return;
    }
}

serviceEvents.onSessionReject = function (sessionEvent) {
    if (sessionEvent && sessionEvent["correlationKey"] && sessionEvent["correlationKey"]["Solace_Msg_Utility_Seq_Num"]) {
        const seqNum = sessionEvent["correlationKey"]["Solace_Msg_Utility_Seq_Num"];
        console.error(`REJECT Received for ${seqNum}`, sessionEvent.infoStr);
        ui.updateForwardItemStatus(seqNum, 'FAILED', sessionEvent.infoStr);
        return;
    }
}

serviceEvents.onGmDisabled = function (queueName) {
    console.error(`[${queueName}] GM Disabled`);
    if (state.currentQueue === queueName) {
        ui.showBrowserError('Guaranteed Messaging is disabled on the broker.');
    }
}

serviceEvents.onMessage = function (queueName, msg) {
    let typeStr = 'Message';
    try {
        if (msg.getType() === solace.MessageType.TEXT) typeStr = 'Text';
        else if (msg.getType() === solace.MessageType.BINARY) typeStr = 'Binary';
        else if (msg.getType() === solace.MessageType.MAP) typeStr = 'Map';
        else if (msg.getType() === solace.MessageType.STREAM) typeStr = 'Stream';
    } catch (e) { }

    // Safely extract content
    let contentStr = '';
    const attachment = msg.getBinaryAttachment();
    const sdtCnt = msg.getSdtContainer();
    if (sdtCnt !== null) {
        if (sdtCnt.getType() === solace.SDTFieldType.STRING) {
            contentStr = sdtCnt.getValue();
        } else if (sdtCnt.getType() === solace.SDTFieldType.MAP) {
            contentStr = '[SDT Map Data - Not Supported Yet]';
        } else if (sdtCnt.getType() === solace.SDTFieldType.STREAM) {
            contentStr = '[SDT Stream Data - Not Supported Yet]';
        } else {
            contentStr = '[SDT Unknown Data - Not Supported Yet]';
        }
    } else if (attachment) {
        if (typeof attachment === 'string') {
            contentStr = attachment;
        } else if (attachment instanceof Uint8Array || attachment instanceof ArrayBuffer) {
            try {
                contentStr = new TextDecoder().decode(attachment);
            } catch (e) { contentStr = '[Binary Data Error]'; }
        } else {
            contentStr = '[Unknown Binary Data]';
        }
    } else {
        contentStr = msg.getXmlContent() || '';
    }

    // TIMESTAMP Handling - Sender Timestamp preference
    let dateStr = 'N/A';
    try {
        const ts = msg.getSenderTimestamp();
        if (ts) {
            const timeVal = (typeof ts.toNumber === 'function') ? ts.toNumber() : ts;
            const d = new Date(timeVal);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dd = String(d.getDate()).padStart(2, '0');
            const mon = months[d.getMonth()];
            const yy = String(d.getFullYear()).slice(-2);
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            const ss = String(d.getSeconds()).padStart(2, '0');
            dateStr = `${dd}-${mon}-${yy} ${hh}:${mm}:${ss}`;
        }
        else
            dateStr = '(No Timestamp)';
    } catch (e) { }

    const m = {
        id: msg.getGuaranteedMessageId() ? msg.getGuaranteedMessageId().toString() : 'N/A',
        date: dateStr,
        size: msg.smfHeader ? msg.smfHeader.messageLength : 0,
        type: typeStr,
        // Standard Properties
        msgProperties: (function () {
            const props = {};
            const m = msg;
            try { if (m.getApplicationMessageId()) props['App Msg Id'] = m.getApplicationMessageId(); } catch (e) { }
            try { if (m.getCacheRequestId()) props['Cache Id'] = m.getCacheRequestId(); } catch (e) { }
            try { if (m.getCorrelationId()) props['Corr Id'] = m.getCorrelationId(); } catch (e) { }
            try { if (m.getDeliveryCount()) props['Delivery Count'] = m.getDeliveryCount(); } catch (e) { }

            try {
                if (m.getDeliveryMode() !== null && m.getDeliveryMode() !== undefined) {
                    let modeStr = 'UNKNOWN';
                    const dm = m.getDeliveryMode();
                    if (dm === 0) modeStr = 'DIRECT';
                    else if (dm === 2) modeStr = 'NON_PERSISTENT';
                    else if (dm === 1) modeStr = 'PERSISTENT';
                    props['Delivery Mode'] = modeStr;
                }
            } catch (e) { }

            try { if (m.getHttpContentEncoding()) props['HTTP Encoding'] = m.getHttpContentEncoding(); } catch (e) { }
            try { if (m.getHttpContentType()) props['HTTP Type'] = m.getHttpContentType(); } catch (e) { }
            try { if (m.getPriority() !== null) props['Priority'] = m.getPriority(); } catch (e) { }
            try { if (m.getReplyTo()) props['Reply To'] = m.getReplyTo().toString(); } catch (e) { }
            try { if (m.getSenderId()) props['Sender Id'] = m.getSenderId(); } catch (e) { }
            try { if (m.getSequenceNumber()) props['SeqNumber'] = m.getSequenceNumber(); } catch (e) { }
            try { if (m.getTimeToLive()) props['TTL'] = m.getTimeToLive(); } catch (e) { }
            try { if (m.getTopicSequenceNumber()) props['TopicSeqNum'] = m.getTopicSequenceNumber(); } catch (e) { }
            return props;
        })(),
        // User/Application Properties (formerly headers)
        appProperties: (function () {
            try {
                const map = msg.getUserPropertyMap();
                if (!map) return {};
                const obj = {};
                const keys = map.getKeys();
                keys.forEach(key => {
                    const field = map.getField(key);
                    if (field && typeof field.getValue === 'function') {
                        obj[key] = field.getValue();
                    } else {
                        obj[key] = field;
                    }
                });
                return obj;
            } catch (e) { return {}; }
        })(),
        content: contentStr,
        _originalMsg: msg // Store original for details
    };

    // Store in State
    addMessage(queueName, m); // Scope function

    // Check if this queue is currently active in UI
    if (state.currentQueue === queueName) {
        state.allMessages = getMessages(queueName);

        // Filter Check for Incoming Message
        if (shouldShowMessage(m)) {
            // If we are in a filtered view, manually add to displayed list
            if (state.displayedMessages !== state.allMessages) {
                state.displayedMessages.push(m);
            }
            ui.addMessageRow(m);
        }
    }
}


// import state, { setBrowser, deleteBrowser } from './state.js';
// import * as serviceEvents from './service-events.js';

const service = {};

service.createBrowser = function (queueName) {
    if (window.App.session && !window.App.config.useMocks) {
        try {
            console.log(`Creating Queue Browser for [${queueName}]...`);

            // Init Store
            if (!state.messageStore.has(queueName)) {
                state.messageStore.set(queueName, []);
            }

            // [LIMIT CHECK] Obfuscated Implementation
            // _0xL represents the max allowed bindings (5)
            const _0xL = 0x3;
            if (state.browserInstances.size >= _0xL) {
                console.warn('[Limit] Max queue bindings reached.');
                alert('Connection Limit Reached: You can only bind to ' + _0xL + ' queues at a time.');
                return;
            }

            const browserProps = new solace.QueueBrowserProperties();
            browserProps.queueDescriptor = new solace.QueueDescriptor({ name: queueName, type: solace.QueueType.QUEUE });
            browserProps.transportAcknowledgeTimeoutInMsecs = 1000;

            const browser = window.App.session.createQueueBrowser(browserProps);

            // Store Instance
            setBrowser(queueName, browser);

            // Event Listeners
            browser.on(solace.QueueBrowserEventName.UP, () => serviceEvents.onBrowserUp(queueName));
            browser.on(solace.QueueBrowserEventName.CONNECT_FAILED_ERROR, (err) => serviceEvents.onConnectFailed(queueName, err));
            browser.on(solace.QueueBrowserEventName.DOWN_ERROR, (err) => serviceEvents.onBrowserDown(queueName, err));
            browser.on(solace.QueueBrowserEventName.GM_DISABLED, () => serviceEvents.onGmDisabled(queueName));
            browser.on(solace.QueueBrowserEventName.MESSAGE, (msg) => serviceEvents.onMessage(queueName, msg));

            // Connect
            browser.connect();

        } catch (e) {
            console.error('Failed to create browser', e);
            alert('Error creating queue browser: ' + e.message);
        }
    }
}

service.disconnectBrowser = function (queueName) {
    const browser = state.browserInstances.get(queueName);
    if (browser) {
        console.log(`Disconnecting browser for [${queueName}]...`);
        try {
            browser.disconnect();
        } catch (e) {
            console.error('Error disconnecting browser', e);
        }
        deleteBrowser(queueName);
    }
    state.messageStore.delete(queueName);
}

service.disconnectAll = function () {
    console.log('[Browser] Global Client Disconnect - Cleaning up browsers...');
    state.browserInstances.forEach((browser, qName) => {
        try { browser.disconnect(); } catch (e) { }
    });
    state.browserInstances.clear();
    state.messageStore.clear();
}

service.forwardMessage = async function (originalMsg, destName, destType, correlationValue) {
    if (!window.App.session) throw new Error('Not connected to Solace.');

    try {
        const newMsg = solace.SolclientFactory.createMessage();

        // 1. Destination
        let destination;
        if (destType === 'Topic') {
            destination = solace.SolclientFactory.createTopicDestination(destName);
        } else {
            destination = solace.SolclientFactory.createDurableQueueDestination(destName);
        }
        newMsg.setDestination(destination);

        // 2. Copy Properties (Try-Catch per setter)
        const safeSet = (setter, getter) => {
            try {
                if (typeof originalMsg._originalMsg[getter] === 'function') {
                    const val = originalMsg._originalMsg[getter]();
                    if (val !== null && val !== undefined) {
                        newMsg[setter](val);
                    }
                }
            } catch (e) {
                console.warn(`Failed to set ${setter}`, e);
            }
        };

        safeSet('setApplicationMessageId', 'getApplicationMessageId');
        safeSet('setApplicationMessageType', 'getApplicationMessageType');
        safeSet('setAsReplyMessage', 'isReplyMessage');
        safeSet('setCorrelationId', 'getCorrelationId');

        // CRITICAL: Force Persistent for ACK tracking
        newMsg.setDeliveryMode(solace.MessageDeliveryModeType.PERSISTENT);

        // CRITICAL: Set Correlation Key for Tracking
        // We use a specific key inside the correlation key object/map, or just the object itself if supported.
        // Solace JS SDK Message.setCorrelationKey(object)
        const correlationKey = {
            "Solace_Msg_Utility_Seq_Num": correlationValue,
            "Original_Msg_ID": originalMsg.id
        };
        newMsg.setCorrelationKey(correlationKey);

        safeSet('setDMQEligible', 'isDMQEligible');
        safeSet('setElidingEligible', 'isElidingEligible');
        safeSet('setGMExpiration', 'getGMExpiration');
        safeSet('setHttpContentEncoding', 'getHttpContentEncoding');
        safeSet('setHttpContentType', 'getHttpContentType');
        safeSet('setPriority', 'getPriority');
        safeSet('setReplyTo', 'getReplyTo');
        safeSet('setSenderId', 'getSenderId');
        safeSet('setSenderTimestamp', 'getSenderTimestamp');
        safeSet('setSequenceNumber', 'getSequenceNumber');
        safeSet('setTimeToLive', 'getTimeToLive');
        safeSet('setUserCos', 'getUserCos');

        // UserData and UserPropertyMap
        safeSet('setUserData', 'getUserData');
        safeSet('setUserPropertyMap', 'getUserPropertyMap');

        // XML Metadata/Content
        safeSet('setXmlMetadata', 'getXmlMetadata');

        // Content Priority: SDT > XML > Binary
        let contentSet = false;

        // 1. SDT
        try {
            const sdt = originalMsg._originalMsg.getSdtContainer();
            if (sdt) {
                newMsg.setSdtContainer(sdt);
                contentSet = true;
            }
        } catch (e) { }

        // 2. XML Content
        if (!contentSet) {
            try {
                const xml = originalMsg._originalMsg.getXmlContent();
                if (xml) {
                    newMsg.setXmlContent(xml);
                    contentSet = true;
                }
            } catch (e) { }
        }

        // 3. Binary Attachment
        if (!contentSet) {
            try {
                const bin = originalMsg._originalMsg.getBinaryAttachment();
                if (bin) {
                    newMsg.setBinaryAttachment(bin);
                    contentSet = true;
                }
            } catch (e) { }
        }

        // SEND
        window.App.session.send(newMsg);

        return newMsg;
    } catch (error) {
        console.error('Failed to create/send forward message:', error);
        throw error;
    }
}

// Robust Deletion Workaround
// Refactored Delete Functionality (Proactive Approach)
// Refactored Delete Functionality (Simplified Proactive Approach)
service.deleteMessages = function (queueName, msgIds) {
    return new Promise((resolve, reject) => {
        if (!queueName || !msgIds || msgIds.length === 0) {
            resolve();
            return;
        }

        if (!window.App.session) {
            window.alert('No active session.');
            reject('No active session');
            return;
        }

        const browser = state.browserInstances.get(queueName);
        if (!browser) {
            console.error('No active browser found for queue', queueName);
            window.alert('Delete failed: Browser not active for this queue.');
            reject('No active browser');
            return;
        }

        console.log(`[Delete] Starting removal of ${msgIds.length} messages from ${queueName}`);

        // 1. Sort IDs (Smallest to Largest)
        const sortedIds = msgIds.map(id => Number(id)).sort((a, b) => a - b);

        // 2. Loop through sorted IDs and Remove
        const removedIds = new Set();

        sortedIds.forEach(id => {
            const idStr = id.toString();
            try {
                // Create minimal message object
                let msg = solace.SolclientFactory.createMessage();
                msg.setGuaranteedMessageId(id);

                // Perform Remove
                try {
                    browser.removeMessageFromQueue(msg);
                    browser.removeMessageFromQueue(msg);

                    // Update UI immediately per row
                    ui.removeMessageRow(idStr);
                    removedIds.add(idStr);
                    console.log(`[Delete] Triggered remove for ${idStr}`);
                    state.allMessages = state.allMessages.filter(m => !removedIds.has(m.id));
                    state.displayedMessages = state.displayedMessages.filter(m => !removedIds.has(m.id));
                    state.messageStore.set(queueName, state.allMessages);

                    ui.updateCounts();
                } catch (ex) {
                    console.error(`[Delete] Remove API call failed for ${idStr}`, ex);
                }

            } catch (err) {
                console.error(`[Delete] Failed to prepare msg ${idStr}`, err);
            }
        });

        // 3. Final State Update / Notification
        if (removedIds.size > 0) {
            state.allMessages = state.allMessages.filter(m => !removedIds.has(m.id));
            state.displayedMessages = state.displayedMessages.filter(m => !removedIds.has(m.id));
            state.messageStore.set(queueName, state.allMessages);

            ui.updateCounts();
            window.alert(`Successfully deleted ${removedIds.size} messages.`);
        } else {
            window.alert('No messages were deleted. Check console for errors.');
        }

        resolve();
    });
}

const state = {
    browserInstances: new Map(), // queueName -> solace.QueueBrowser
    messageStore: new Map(),     // queueName -> Array<Message>
    currentQueue: '',
    currentQueuePermissions: null,
    allMessages: [],
    displayedMessages: [],
    forwardQueue: [], // Array of messages to forward
    activeFilters: { content: '', msgId: '', dest: '', type: 'ANY', msgType: 'ANY', criteria: 'OR' }
};

// No default export needed in closure scope

function getBrowser(queueName) {
    return state.browserInstances.get(queueName);
}

function setBrowser(queueName, browser) {
    state.browserInstances.set(queueName, browser);
}

function deleteBrowser(queueName) {
    state.browserInstances.delete(queueName);
}

function getMessages(queueName) {
    return state.messageStore.get(queueName);
}

function setMessages(queueName, messages) {
    state.messageStore.set(queueName, messages);
}

function addMessage(queueName, message) {
    const store = state.messageStore.get(queueName);
    if (store) {
        store.push(message);
    }
}

function clearStore() {
    state.messageStore.clear();
}

// Helper for Wildcard Match
function matchString(text, pattern) {
    if (!pattern) return true;

    // If pattern contains '*', use regex for wildcard
    if (pattern.includes('*')) {
        // Escape regex characters except *
        const escapeRegex = (str) => str.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
        // Split by * to create regex parts AND join by .*
        const regexStr = '^' + pattern.split('*').map(escapeRegex).join('.*') + '$';
        const regex = new RegExp(regexStr, 'i'); // Case insensitive
        return regex.test(text);
    }

    // Otherwise, Exact Match (Case Insensitive)
    return text.toLowerCase() === pattern.toLowerCase();
}

// Logic extracted from ui-events to be shared with service-events
function shouldShowMessage(msg) {
    // Current Active Filters - DO NOT lower() here, let matchString handle casing
    const fContent = state.activeFilters.content;
    const fId = state.activeFilters.msgId;
    const fDest = state.activeFilters.dest;
    const fDestType = state.activeFilters.type;
    const fMsgType = state.activeFilters.msgType;
    const criteria = state.activeFilters.criteria || 'OR';

    // Define Conditions: { active: boolean, match: boolean }
    const conditions = [];

    // 1. Content
    if (fContent) {
        // Use 'Contains' matching for content/body as per user request
        //if (!fContent.includes('*')) {
        const content = msg.content || '';
        conditions.push({ active: true, match: content.toLowerCase().includes(fContent.toLowerCase()) });
        //} else {
        // Fallback to matchString for wildcards
        //    conditions.push({ active: true, match: matchString(msg.content, fContent) });
        //}
    }

    // 2. ID
    if (fId) {
        conditions.push({ active: true, match: matchString(msg.id, fId) });
    }

    // 3. Message Type (Check State UI logic for values)
    if (fMsgType !== 'ANY') {
        const currentType = msg.type || '';
        conditions.push({ active: true, match: currentType === fMsgType }); // Enum match
    }

    // 4. Destination (Composite)
    if (fDest || fDestType !== 'ANY') {
        let matchDest = true;

        let msgDestName = '';
        let msgDestType = '';

        // Extract dest info
        if (msg._originalMsg && msg._originalMsg.getDestination()) {
            msgDestName = msg._originalMsg.getDestination().getName() || '';
            const t = msg._originalMsg.getDestination().getType();
            if (window.solace) {
                if (t === window.solace.DestinationType.TOPIC) msgDestType = 'Topic';
                else if (t === window.solace.DestinationType.QUEUE) msgDestType = 'Queue';
            }
        }

        if (fDest && !matchString(msgDestName, fDest)) matchDest = false;
        if (fDestType !== 'ANY' && msgDestType !== fDestType) matchDest = false;

        conditions.push({ active: true, match: matchDest });
    }

    // 5. Properties (Multiple)
    if (state.activeFilters.properties && state.activeFilters.properties.length > 0) {
        state.activeFilters.properties.forEach(prop => {
            const fKey = prop.key.trim();
            // Key is case-insensitive exact match
            const fKeyLower = fKey.toLowerCase();
            const fVal = prop.value;

            let matchProp = false;

            // Check Standard Properties
            if (msg.msgProperties) {
                // Find matching key (case-insensitive)
                const foundKey = Object.keys(msg.msgProperties).find(k => k.toLowerCase() === fKeyLower);
                if (foundKey) {
                    const val = String(msg.msgProperties[foundKey] || '');
                    if (matchString(val, fVal)) matchProp = true;
                }
            }

            // Check App Properties
            if (!matchProp && msg.appProperties) {
                const foundKey = Object.keys(msg.appProperties).find(k => k.toLowerCase() === fKeyLower);
                if (foundKey) {
                    const val = String(msg.appProperties[foundKey] || '');
                    if (matchString(val, fVal)) matchProp = true;
                }
            }

            conditions.push({ active: true, match: matchProp });
        });
    }

    // Evaluate
    if (conditions.length === 0) return true;
    else if (criteria === 'AND') {
        // All conditions must match. If NO filter is active, it's a pass.
        // Array only contains active conditions logic above if written differently
        // But here `conditions` only contains filters the user actually set.
        return conditions.every(c => c.match);
    } else {
        // OR: At least one active must match.
        return conditions.some(c => c.match);
    }
}


// import state from './state.js'; // Scope assumption
// import * as ui from './ui.js';   // Scope assumption
// import * as service from './service.js'; // Scope assumption

const uiEvents = {};

uiEvents.handleCopyContent = async function () {
    const els = ui.getElements();
    if (!state.selectedMessage) {
        return;
    }

    const content = state.selectedMessage.content || '';
    if (window.App && window.App.copyToClipboard) {
        await window.App.copyToClipboard(content, els.btnCopyContent);
    } else {
        console.error('App.copyToClipboard not found');
    }
}

uiEvents.handleForwardSend = async function () {
    const els = ui.getElements();
    const destName = els.inputForwardDestName.value.trim();
    const destType = els.inputForwardDestType.value;

    if (!state.forwardQueue || state.forwardQueue.length === 0) {
        ui.onForwardFailure('No messages to forward.');
        return;
    }

    if (!destName) {
        ui.onForwardFailure('Destination Name is required.');
        return;
    }

    // Reset UI State
    els.btnForwardSend.disabled = true;
    els.btnForwardSend.textContent = 'Sending...';
    els.elForwardError.style.display = 'none';
    state.forwardingCancelled = false;
    els.btnForwardSend.classList.add('btn-secondary');
    els.btnForwardSend.classList.remove('btn-primary');

    // Iterate
    for (const item of state.forwardQueue) {
        if (state.forwardingCancelled) {
            console.log('Forwarding Cancelled by User');
            break;
        }

        // Skip if already success (retry logic?) - For now assume fresh send
        if (item.status === 'SUCCESS') continue;

        try {
            // Update UI to Spinner
            ui.updateForwardItemStatus(item.correlationValue, 'SENDING');

            // Send (Now Async)
            await service.forwardMessage(item.originalMsg, destName, destType, item.correlationValue);

            // Tiny delay to allow UI to breathe or batching prevent flood
            await new Promise(r => setTimeout(r, 50));

        } catch (e) {
            ui.updateForwardItemStatus(item.correlationValue, 'FAILED', 'Unable to send message.');
        }
    }
}

uiEvents.handleBulkForward = function () {
    const selectedIds = ui.getSelectedMessageIds();
    if (selectedIds.length === 0) return;

    const messages = selectedIds.map(id => state.displayedMessages.find(m => m.id === id)).filter(Boolean);
    if (messages.length > 0) {
        ui.showForwardModal(messages);
    }
}

uiEvents.handleBindClick = function () {
    const els = ui.getElements();
    const queueName = els.inputBind.value.trim();

    // Clear previous errors
    ui.showBindError(null);

    if (queueName) {
        if (state.browserInstances.has(queueName)) {
            ui.showBindError(`Queue "${queueName}" is already bound.`);
            return;
        }

        // Disable button temporarily to prevent double submission? 
        // Or just let the service handle it. 
        // For better UX, we could disable. 
        // els.btnBind.disabled = true; // Re-enable on success/failure in events?
        // Let's keep it simple for now as per instructions: Just don't add to list.

        // Trigger Service - Logic moved to service-events for UI update
        service.createBrowser(queueName);

        // Clear input to indicate something happened, or keep it until success?
        // Usually better to keep it until success in case of typo, but standard is to clear.
        // Let's clear it only on success (in service-events or ui-events callback?).
        // If we don't clear, user might click again.
        // Let's clear here for now to match previous behavior, OR let's wait.
        // Requirement: "error ... displayed ... below the queue name".
        // If error, input text should remain.
        // So we should NOT clear input here.
        // We will clear input in onBrowserUp (Success).
    }
}

uiEvents.handleUnbindClick = function () {
    const els = ui.getElements();
    const selectedIndex = els.selectBound.selectedIndex;
    if (selectedIndex > 0) {
        const qName = els.selectBound.value;

        // Disconnect
        service.disconnectBrowser(qName);

        els.selectBound.remove(selectedIndex);

        // Reset state
        if (els.selectBound.options.length > 1) {
            els.selectBound.selectedIndex = 1;
            els.selectBound.dispatchEvent(new Event('change'));
        } else {
            // Updated Logic: Don't hide the panel, just reset selection
            ui.resetQueueSelection();

            // Also explicitly make sure dropdown is back to default if needed (it should be empty/default)
            els.selectBound.selectedIndex = 0;
        }
    }
}

uiEvents.handleDropdownChange = function () {
    const els = ui.getElements();
    const qName = els.selectBound.value;
    state.currentQueue = qName;
    els.hdrQueueName.textContent = qName;
    ui.showBrowserError(null);

    if (qName) {
        ui.updatePermissionUI(qName);
        if (state.messageStore.has(qName)) {
            state.allMessages = state.messageStore.get(qName);
        } else {
            // Check for mocks or empty
            state.allMessages = [];
            if (!window.App.config.useMocks && !state.messageStore.has(qName)) {
                state.allMessages = [];
            }
        }
    } else {
        els.hdrPermissions.classList.add('hidden');
        state.allMessages = [];
    }

    // Clear Details Panel on Queue Change
    ui.clearDetails();

    // Reset filters
    // Reset filters
    state.activeFilters = { content: '', msgId: '', dest: '', type: 'ANY', msgType: 'ANY', criteria: 'OR' };
    if (els.inputFilterContent) els.inputFilterContent.value = '';
    if (els.inputFilterId) els.inputFilterId.value = '';
    if (els.inputFilterDest) els.inputFilterDest.value = '';
    if (els.inputFilterType) els.inputFilterType.value = 'ANY';
    if (els.inputFilterMsgType) els.inputFilterMsgType.value = 'ANY';
    // Reset Radio (Default OR)
    if (els.radFilterCriteria) {
        els.radFilterCriteria.forEach(r => r.checked = (r.value === 'OR'));
    }

    state.displayedMessages = state.allMessages;

    // Reset Filter Button State
    if (els.btnFilter) {
        els.btnFilter.classList.remove('filter-active');
        els.btnFilter.disabled = !qName;
    }

    ui.renderList();
}



// Let's modify applyFilters and clearFilters first.

uiEvents.removeFilterRow = function (btn) {
    if (btn && btn.parentElement) btn.parentElement.remove();
}

uiEvents.clearFilters = function () {
    const els = ui.getElements();
    // Reset inputs
    if (els.inputFilterContent) els.inputFilterContent.value = '';
    if (els.inputFilterId) els.inputFilterId.value = '';
    if (els.inputFilterDest) els.inputFilterDest.value = '';
    if (els.inputFilterType) els.inputFilterType.value = 'ANY';
    if (els.inputFilterMsgType) els.inputFilterMsgType.value = 'ANY';
    if (els.radFilterCriteria) {
        els.radFilterCriteria.forEach(r => r.checked = (r.value === 'OR'));
    }

    // Clear Properties
    if (ui.clearPropertyFilters) ui.clearPropertyFilters();

    // Reset State (Keep consistent default)
    state.activeFilters = { content: '', msgId: '', dest: '', type: 'ANY', msgType: 'ANY', properties: [], criteria: 'OR' };
    state.displayedMessages = state.allMessages;

    // Update UI
    const elsBtn = ui.getElements();
    if (elsBtn.btnFilter) elsBtn.btnFilter.classList.remove('filter-active');

    ui.renderList();
    if (els.modalFilter) els.modalFilter.classList.add('hidden');
}

uiEvents.applyFilters = function () {
    const els = ui.getElements();
    // Update active filters from Inputs
    if (els.inputFilterContent) state.activeFilters.content = els.inputFilterContent.value;
    if (els.inputFilterId) state.activeFilters.msgId = els.inputFilterId.value;
    if (els.inputFilterDest) state.activeFilters.dest = els.inputFilterDest.value;
    if (els.inputFilterType) state.activeFilters.type = els.inputFilterType.value;
    if (els.inputFilterMsgType) state.activeFilters.msgType = els.inputFilterMsgType.value;

    // Properties
    if (ui.getPropertyFilters) {
        state.activeFilters.properties = ui.getPropertyFilters();
    }

    // Logic
    if (els.radFilterCriteria) {
        els.radFilterCriteria.forEach(r => {
            if (r.checked) state.activeFilters.criteria = r.value;
        });
    }

    // Use shared filter logic
    state.displayedMessages = state.allMessages.filter(shouldShowMessage);

    // Update Filter Button State
    const hasActiveFilter = !!(
        state.activeFilters.content ||
        state.activeFilters.msgId ||
        state.activeFilters.dest ||
        (state.activeFilters.type !== 'ANY') ||
        (state.activeFilters.msgType !== 'ANY') ||
        (state.activeFilters.properties && state.activeFilters.properties.length > 0)
    );
    if (hasActiveFilter) {
        els.btnFilter.classList.add('filter-active');
    } else {
        els.btnFilter.classList.remove('filter-active');
    }

    // Clear Details and Selection (User Request)
    ui.clearDetails();

    ui.renderList();
    if (els.modalFilter) els.modalFilter.classList.add('hidden');
}

uiEvents.handleBulkDownloadContent = function () {
    ui.downloadMessagesZip('content');
}

uiEvents.handleBulkDownloadFull = function () {
    ui.downloadMessagesZip('full');
}

uiEvents.handleDelete = async function (msgId) {
    if (!msgId) return;
    const confirm = window.confirm(`Are you sure you want to delete message ${msgId}?`);
    if (confirm) {
        await service.deleteMessages(state.currentQueue, [msgId]);
    }
}

uiEvents.handleBulkDelete = async function () {
    const selectedIds = ui.getSelectedMessageIds();
    if (selectedIds.length === 0) return;

    const confirm = window.confirm(`Are you sure you want to delete ${selectedIds.length} selected message(s)?`);
    if (confirm) {
        await service.deleteMessages(state.currentQueue, selectedIds);
    }
}


// import { icons } from './constants.js'; // Available in scope
// import state, { getBrowser } from './state.js'; // Available in scope

const els = {};
// Expose UI functions via a local namespace or directly if valid.
// Since other files import * as ui, let's create a ui object to match the usage `ui.renderList`.
const ui = {};

ui.initElements = function (container) {
    els.container = container;

    // Headers
    els.hdrVpnName = container.querySelector('#browser-vpn-name');
    els.hdrQueueName = container.querySelector('#browser-queue-name');
    els.hdrPermissions = container.querySelector('#browser-permissions');

    // Bind Controls
    els.inputBind = container.querySelector('#browser-bind-input');
    els.btnBind = container.querySelector('#btn-browser-bind');
    els.selectBound = container.querySelector('#browser-bound-queues');
    els.btnUnbind = container.querySelector('#btn-browser-unbind');
    els.elBindError = container.querySelector('#browser-bind-error'); // Added error container

    // Message List & Counts
    els.msgList = container.querySelector('#browser-msg-list');
    els.checkAll = container.querySelector('#browser-select-all');
    els.countTotal = container.querySelector('#count-total');
    els.countDisplayed = container.querySelector('#count-displayed');
    els.countSelected = container.querySelector('#count-selected');
    els.btnRefresh = container.querySelector('#btn-browser-refresh');

    // Details Panel
    els.detailId = container.querySelector('#detail-msg-id');
    els.detailDest = container.querySelector('#detail-destination');
    els.detailTypeBadge = container.querySelector('#detail-type-badge');
    els.detailDestBadge = container.querySelector('#detail-dest-badge');
    els.detailReplMsgId = container.querySelector('#detail-repl-msg-id');
    els.btnCopyDest = container.querySelector('#btn-copy-dest'); // New
    els.btnCopyReplMsgId = container.querySelector('#btn-copy-repl-msg-id'); // New
    els.propContainer = container.querySelector('#detail-properties-container');
    els.headerContainer = container.querySelector('#detail-headers-container');
    els.headerContainer = container.querySelector('#detail-headers-container');
    els.detailContent = container.querySelector('#detail-content');
    els.btnCopyContent = container.querySelector('#btn-copy-content');

    // Raw Content
    els.btnShowRaw = container.querySelector('#btn-show-raw');
    els.modalRaw = container.querySelector('#browser-raw-content-modal');
    els.btnRawClose = container.querySelector('#btn-raw-close');
    els.rawContentText = container.querySelector('#raw-content-text');

    // Forward Modal Elements
    els.modalForward = container.querySelector('#browser-forward-modal');
    els.inputForwardDestName = container.querySelector('#forward-dest-name');
    els.inputForwardDestType = container.querySelector('#forward-dest-type');
    els.btnForwardCancel = container.querySelector('#btn-forward-cancel');
    els.btnForwardSend = container.querySelector('#btn-forward-send');
    els.btnForwardClose = container.querySelector('#btn-forward-close'); // New
    els.elForwardError = container.querySelector('#forward-error');
    els.listForwardMsgs = container.querySelector('#forward-msg-list');

    // Filter Controls
    els.btnFilter = container.querySelector('#btn-browser-filter');
    els.modalFilter = container.querySelector('#browser-filter-modal');
    els.btnFilterCancel = container.querySelector('#btn-filter-cancel');
    els.btnFilterClear = container.querySelector('#btn-filter-clear');
    els.btnFilterApply = container.querySelector('#btn-filter-apply');
    els.inputFilterContent = container.querySelector('#filter-content');
    els.inputFilterId = container.querySelector('#filter-msg-id');

    // Bulk Actions
    els.btnBrowserDownloadContent = container.querySelector('#btn-browser-download-content');
    els.btnBrowserDownloadFull = container.querySelector('#btn-browser-download-full');
    els.btnBrowserForward = container.querySelector('#btn-browser-forward');
    els.btnBrowserDelete = container.querySelector('#btn-browser-delete');
    els.inputFilterMsgType = container.querySelector('#filter-msg-type'); // New
    els.inputFilterDest = container.querySelector('#filter-destination');
    els.inputFilterType = container.querySelector('#filter-destination-type');
    els.radFilterCriteria = container.querySelectorAll('input[name="filter-criteria"]'); // New
    els.btnAddPropFilter = container.querySelector('#btn-add-prop-filter');
    els.filterPropsRows = container.querySelector('#filter-properties-rows');

    // Error
    els.elBrowserError = container.querySelector('#browser-connect-error');

    // Visibility
    els.elPrompt = container.querySelector('#browser-connect-prompt');
    els.elActiveView = container.querySelector('#browser-active-view');

    // Bulk Actions
    els.btnBulkDownload = container.querySelector('#btn-browser-download');
    // els.btnBulkResend removed (redundant)
    els.btnBulkDelete = container.querySelector('#btn-browser-delete');

    return els;
}

ui.getElements = function () {
    return els;
}

ui.getSelectedMessageIds = function () {
    if (!els.msgList) return [];
    const checkedBoxes = Array.from(els.msgList.querySelectorAll('.msg-check:checked'));
    return checkedBoxes.map(cb => cb.closest('tr').dataset.id);
}

ui.showBrowserError = function (msg) {
    if (els.elBrowserError) {
        if (msg) {
            els.elBrowserError.textContent = msg;
            els.elBrowserError.style.display = 'block';
        } else {
            els.elBrowserError.style.display = 'none';
        }
    }
}

// New Function: Show Inline Bind Error
// New Function: Show Inline Bind Error
ui.showBindError = function (msg) {
    if (els.elBindError && els.inputBind) {
        if (msg) {
            els.elBindError.textContent = msg;
            els.elBindError.style.display = 'block'; // Force show as invalid-feedback
            els.inputBind.classList.add('is-invalid');
        } else {
            els.elBindError.textContent = '';
            els.elBindError.style.display = 'none';
            els.inputBind.classList.remove('is-invalid');
        }
    }
}

// Download Helper
ui.triggerDownload = function (filename, content, type = 'text/plain') {
    const blob = new Blob([content], { type: type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

ui.triggerDownloadBlob = function (blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

ui.downloadMessageContent = function (msg) {
    if (!msg) return;
    const filename = `solace-message-${msg.id.replace(/[^a-zA-Z0-9-_]/g, '')}`; // Sanitize ID
    // Check if content is available
    const content = msg.content || '';
    ui.triggerDownload(filename, content);
}

ui.getFullMessageJson = function (msg) {
    if (!msg) return null;
    const fullObj = {
        messageProperties: {
            ...msg.msgProperties,
            destination: {
                name: 'Unknown',
                type: 'Unknown'
            },
            messageType: msg.type
        },
        applicationProperties: msg.appProperties,
        payload: msg.content
    };

    // Try to extract destination from original msg if available, or fallback to cached UI data
    if (msg._originalMsg) {
        try {
            const dest = msg._originalMsg.getDestination();
            if (dest) {
                fullObj.messageProperties.destination.name = dest.getName();
                const dType = dest.getType();
                if (window.solace) {
                    if (dType === window.solace.DestinationType.TOPIC) fullObj.messageProperties.destination.type = 'Topic';
                    else if (dType === window.solace.DestinationType.QUEUE) fullObj.messageProperties.destination.type = 'Queue';
                    else fullObj.messageProperties.destination.type = dType.toString();
                } else {
                    fullObj.messageProperties.destination.type = dType.toString();
                }
            }
        } catch (e) {
            console.warn('Failed to extract destination details', e);
        }
    }
    return fullObj;
}

ui.downloadMessageFull = function (msg) {
    const fullObj = ui.getFullMessageJson(msg);
    if (!fullObj) return;

    const filename = `solace-message-${msg.id.replace(/[^a-zA-Z0-9-_]/g, '')}-full.json`;
    ui.triggerDownload(filename, JSON.stringify(fullObj, null, 2), 'application/json');
}

ui.downloadMessagesZip = async function (type) {
    if (!window.JSZip) {
        alert('JSZip library not loaded. Cannot create ZIP.');
        return;
    }

    // Get Checked Messages
    const checkedBoxes = Array.from(document.querySelectorAll('.msg-check:checked'));
    if (checkedBoxes.length === 0) {
        alert('No messages selected.');
        return;
    }

    const ids = checkedBoxes.map(cb => cb.closest('tr').dataset.id);
    const msgs = state.displayedMessages.filter(m => ids.includes(String(m.id)));

    if (msgs.length === 0) return;

    const zip = new JSZip();
    const now = new Date();
    const pad = n => n.toString().padStart(2, '0');
    const timestamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}-${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;

    let zipFilename = '';

    if (type === 'content') {
        zipFilename = `solace-messages-content-${timestamp}.zip`;
        msgs.forEach(msg => {
            const filename = `solace-message-${msg.id.replace(/[^a-zA-Z0-9-_]/g, '')}`;
            const content = msg.content || '';
            zip.file(filename, content);
        });
    } else if (type === 'full') {
        zipFilename = `solace-messages-full-${timestamp}.zip`;
        msgs.forEach(msg => {
            const fullObj = ui.getFullMessageJson(msg);
            const filename = `solace-message-${msg.id.replace(/[^a-zA-Z0-9-_]/g, '')}-full.json`;
            zip.file(filename, JSON.stringify(fullObj, null, 2));
        });
    }

    try {
        const content = await zip.generateAsync({ type: 'blob' });
        ui.triggerDownloadBlob(content, zipFilename);
    } catch (err) {
        console.error('Failed to generate ZIP:', err);
        alert('Failed to generate ZIP file.');
    }
}

// New Function: Format Bytes
ui.formatBytes = function (bytes, decimals = 2) {
    bytes = Number(bytes);
    if (bytes === 0 || isNaN(bytes)) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    // Switch unit if >= 1000 to avoid displaying "1000 B" (user request)
    let i = 0;
    while (bytes >= 1000 && i < sizes.length - 1) {
        bytes /= k;
        i++;
    }
    return parseFloat(bytes.toFixed(decimals)) + ' ' + sizes[i];
}

// New Function: Add Queue to Dropdown (called on success)
ui.addQueueToDropdown = function (queueName) {
    if (!els.selectBound) return;

    let exists = false;
    for (let i = 0; i < els.selectBound.options.length; i++) {
        if (els.selectBound.options[i].value === queueName) exists = true;
    }

    if (!exists) {
        const opt = document.createElement('option');
        opt.value = queueName;
        opt.textContent = queueName;
        els.selectBound.appendChild(opt);
    }

    // Auto-select
    els.selectBound.value = queueName;
    els.selectBound.dispatchEvent(new Event('change'));
}

ui.updateCounts = function () {
    if (els.countTotal) els.countTotal.textContent = state.allMessages.length;
    if (els.countDisplayed) els.countDisplayed.textContent = state.displayedMessages.length;

    const checked = els.msgList ? els.msgList.querySelectorAll('.msg-check:checked').length : 0;
    if (els.countSelected) els.countSelected.textContent = checked;

    // Update Bulk Buttons State
    const hasSelection = checked > 0;
    const isReadOnly = state.currentQueuePermissions && state.currentQueuePermissions.READ_ONLY;

    if (els.btnBrowserDownloadContent) els.btnBrowserDownloadContent.disabled = !hasSelection;
    if (els.btnBrowserDownloadFull) els.btnBrowserDownloadFull.disabled = !hasSelection;
    if (els.btnBrowserDownloadFull) els.btnBrowserDownloadFull.disabled = !hasSelection;
    // Forward (Single or Bulk)
    if (els.btnBrowserForward) els.btnBrowserForward.disabled = (checked === 0);

    if (els.btnBrowserDelete) {
        if (isReadOnly) {
            els.btnBrowserDelete.classList.add('hidden');
        } else {
            els.btnBrowserDelete.classList.remove('hidden');
            els.btnBrowserDelete.disabled = !hasSelection;
        }
    }
}

ui.updatePermissionUI = function (queueName) {
    const browser = getBrowser(queueName);
    const consumer = browser ? browser._messageConsumer : null;
    const perms = consumer ? consumer._permissions : null;

    // VERBOSE DEBUGGING (Removed redundant large objects to avoid spam, kept summary)
    // User reported duplication, likely from multiple calls. 
    // We will keep a cleaner log here.
    console.log(`[Permissions] Computed for ${queueName}:`, perms);

    let isReadOnly = false;
    if (perms) {
        // Handle Enum String or Object
        // Solace sometimes returns just the string "READ_ONLY" or an object { READ_ONLY: true }
        if (typeof perms === 'string' && perms === 'READ_ONLY') isReadOnly = true;
        // Check for Object { READ_ONLY: true/value }
        // else if (typeof perms === 'object' && perms.READ_ONLY) isReadOnly = true;
        // Also check if window.solace is available and compare with enum
        //else if (window.solace && perms === window.solace.QueuePermissions.READ_ONLY) isReadOnly = true;
    }

    // Normalize state for render logic
    state.currentQueuePermissions = isReadOnly ? { READ_ONLY: true } : { READ_ONLY: false };

    if (perms) {
        els.hdrPermissions.classList.remove('hidden');
        if (isReadOnly) {
            els.hdrPermissions.textContent = 'Read-Only';
            els.hdrPermissions.className = 'badge badge-outline-warning';
        } else {
            els.hdrPermissions.textContent = 'Read-Write';
            els.hdrPermissions.className = 'badge badge-outline-success';
        }
    } else {
        els.hdrPermissions.classList.add('hidden');
        state.currentQueuePermissions = null;
    }

    // Refresh table to update delete icons based on perms
    ui.renderList();
    ui.updateCounts();
}

ui.selectMessage = function (id) {
    // Highlight row
    if (els.msgList) {
        els.msgList.querySelectorAll('tr').forEach(tr => {
            if (tr.dataset.id === id) {
                tr.classList.add('selected');
            } else {
                tr.classList.remove('selected');
            }
        });
    }

    const msg = state.displayedMessages.find(m => m.id === id);
    if (msg) {
        state.selectedMessage = msg;
        els.detailId.textContent = msg.id;

        els.detailTypeBadge.textContent = msg.type;
        els.detailTypeBadge.className = 'badge badge-outline-info';
        els.detailTypeBadge.classList.remove('hidden');

        if (msg._originalMsg) {
            const dest = msg._originalMsg.getDestination();
            if (dest) {
                const destName = dest.getName();
                els.detailDest.textContent = destName;
                const destType = dest.getType();
                let typeLabel = destType.toString();
                if (window.solace) {
                    if (destType === window.solace.DestinationType.TOPIC) typeLabel = 'Topic';
                    else if (destType === window.solace.DestinationType.QUEUE) typeLabel = 'Queue';
                }
                els.detailDestBadge.textContent = typeLabel;
            } else {
                els.detailDest.textContent = 'N/A';
                els.detailDestBadge.textContent = 'Unknown';
            }

            // Repl Grp Msg Id
            if (msg._originalMsg && typeof msg._originalMsg.getReplicationGroupMessageId === 'function') {
                try {
                    const rmid = msg._originalMsg.getReplicationGroupMessageId();
                    els.detailReplMsgId.textContent = rmid ? rmid.toString() : 'N/A';
                } catch (e) { els.detailReplMsgId.textContent = 'N/A'; }
            } else {
                els.detailReplMsgId.textContent = 'N/A';
            }

        } else {
            els.detailDest.textContent = els.hdrQueueName.textContent || 'N/A';
            els.detailDestBadge.textContent = 'Queue'; // Fallback
            els.detailReplMsgId.textContent = 'N/A';
        }

        els.detailDestBadge.className = 'badge badge-outline-success';
        els.detailDestBadge.classList.remove('hidden');

        els.detailDestBadge.classList.remove('hidden');

        // Render Message Properties
        ui.renderTags(els.propContainer, msg.msgProperties);

        // Render Application Properties
        ui.renderTags(els.headerContainer, msg.appProperties);

        els.detailContent.textContent = msg.content;

        if (els.btnShowRaw) {
            els.btnShowRaw.disabled = false;
            els.btnShowRaw.onclick = () => ui.showRawContent(msg);
        }
        if (els.btnCopyContent) {
            els.btnCopyContent.disabled = false;
        }

        // Enable Copy Buttons
        if (els.btnCopyDest) {
            els.btnCopyDest.disabled = false;
            els.btnCopyDest.onclick = () => window.App.copyToClipboard(els.detailDest.textContent, els.btnCopyDest);
        }
        if (els.btnCopyReplMsgId) {
            els.btnCopyReplMsgId.disabled = false;
            els.btnCopyReplMsgId.onclick = () => window.App.copyToClipboard(els.detailReplMsgId.textContent, els.btnCopyReplMsgId);
        }
    }
}

ui.showRawContent = function (msg) {
    if (els.modalRaw && els.rawContentText) {
        els.rawContentText.textContent = msg._originalMsg ? msg._originalMsg.dump() : 'No raw dump available.';
        els.modalRaw.classList.remove('hidden');

        if (els.btnRawClose) {
            els.btnRawClose.onclick = () => els.modalRaw.classList.add('hidden');
        }
    }
}

ui.clearDetails = function () {
    els.detailId.textContent = '';
    els.detailDest.textContent = '';
    if (els.detailReplMsgId) els.detailReplMsgId.textContent = '';
    if (els.propContainer) els.propContainer.innerHTML = '';
    if (els.headerContainer) els.headerContainer.innerHTML = '';
    els.detailContent.textContent = '';
    els.btnShowRaw.disabled = true;
    if (els.btnCopyContent) els.btnCopyContent.disabled = true;
    if (els.btnCopyDest) els.btnCopyDest.disabled = true;
    if (els.btnCopyReplMsgId) els.btnCopyReplMsgId.disabled = true;
    els.detailTypeBadge.classList.add('hidden');
    els.detailDestBadge.classList.add('hidden');

    if (els.msgList) {
        els.msgList.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));
    }
}

// Helper to create row HTML
ui.createRowHtml = function (msg) {
    const isReadOnly = state.currentQueuePermissions && state.currentQueuePermissions.READ_ONLY;
    // Note: icons object is unavailable here if not imported. 
    // Assuming icons are available via closure or global if this file was built?
    // In strict module mode, we need access to 'icons'.
    // Review shows 'icons' is used in renderList (line 263).
    // So it must be available.

    return `
        <tr data-id="${msg.id}" class="clickable-row">
            <td class="row-checkbox"><input type="checkbox" class="msg-check"></td>
            <td>${msg.id}</td>
            <td>${msg.date}</td>
            <td>${ui.formatBytes(msg.size)}</td>
            <td>
                <div class="browser-actions">
                    <button class="btn-icon btn-download-content" title="Download Content (Payload)">${icons.downloadContent}</button>
                    <button class="btn-icon btn-download-full" title="Download Full Message (JSON)">${icons.downloadFull}</button>
                    <button class="btn-icon btn-forward-row" title="Forward Message">${icons.forward}</button>
                    ${!isReadOnly ? `<button class="btn-icon btn-delete-row" title="Delete" style="color: var(--status-disconnected);">${icons.delete}</button>` : ''}
                </div>
            </td>
        </tr>
    `;
};

// Helper to attach listeners to a row
ui.attachRowListeners = function (tr) {
    // Row Click (Select)
    tr.addEventListener('click', (e) => {
        if (e.target.closest('input') || e.target.closest('button')) return;
        ui.selectMessage(tr.dataset.id);
    });

    // Download Content Trigger
    const btnDownContent = tr.querySelector('.btn-download-content');
    if (btnDownContent) {
        btnDownContent.addEventListener('click', (e) => {
            e.stopPropagation();
            const msg = state.displayedMessages.find(m => m.id === tr.dataset.id);
            if (msg) ui.downloadMessageContent(msg);
        });
    }

    // Download Full Trigger
    const btnDownFull = tr.querySelector('.btn-download-full');
    if (btnDownFull) {
        btnDownFull.addEventListener('click', (e) => {
            e.stopPropagation();
            const msg = state.displayedMessages.find(m => m.id === tr.dataset.id);
            if (msg) ui.downloadMessageFull(msg);
        });
    }

    // Forward Trigger
    const btnForward = tr.querySelector('.btn-forward-row');
    if (btnForward) {
        btnForward.addEventListener('click', (e) => {
            e.stopPropagation();
            const msg = state.displayedMessages.find(m => m.id === tr.dataset.id);
            if (msg) ui.showForwardModal(msg);
        });
    }

    // Checkbox Trigger
    const chk = tr.querySelector('.msg-check');
    if (chk) {
        chk.addEventListener('change', ui.updateCounts);
    }

    // Delete Button Trigger
    const btnDel = tr.querySelector('.btn-delete-row');
    if (btnDel) {
        btnDel.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent selection
            window.dispatchEvent(new CustomEvent('app:message-delete', { detail: { id: tr.dataset.id } }));
        });
    }
};

ui.renderList = function () {
    if (!els.msgList) return;

    // Reset Check All
    if (els.checkAll) els.checkAll.checked = false;

    // Use Helper
    els.msgList.innerHTML = state.displayedMessages.map(msg => ui.createRowHtml(msg)).join('');

    ui.updateCounts();

    // Attach Listeners
    els.msgList.querySelectorAll('tr').forEach(tr => ui.attachRowListeners(tr));
}

ui.addMessageRow = function (msg) {
    if (!els.msgList) return;

    // Create temp container to parse HTML
    const temp = document.createElement('tbody');
    temp.innerHTML = ui.createRowHtml(msg);
    const tr = temp.firstElementChild;

    if (tr) {
        ui.attachRowListeners(tr);
        els.msgList.appendChild(tr); // Append to bottom

        // Highlight New? Maybe flash?
        tr.style.animation = 'highlight-fade 2s'; // Assume CSS handles keyframes or ignored

        ui.updateCounts();
    }
}

ui.removeMessageRow = function (msgId) {
    if (!els.msgList) return;

    const tr = els.msgList.querySelector(`tr[data-id="${msgId}"]`);
    if (tr) {
        tr.remove();
        ui.updateCounts();

        // If selected, clear details
        if (els.detailId && els.detailId.textContent === msgId.toString()) {
            ui.clearDetails();
        }
    }
}

// New Function: Reset selection only (don't hide panel)
// New Function: Reset selection only (don't hide panel)
ui.resetQueueSelection = function () {
    if (els.hdrQueueName) els.hdrQueueName.textContent = '';
    if (els.hdrPermissions) els.hdrPermissions.classList.add('hidden');
    state.currentQueue = '';
    state.allMessages = [];
    state.displayedMessages = [];
    state.currentQueuePermissions = null;

    // Reset Filters
    state.activeFilters = { content: '', msgId: '', dest: '', type: 'ANY', msgType: 'ANY', criteria: 'OR' };
    if (els.inputFilterContent) els.inputFilterContent.value = '';
    if (els.inputFilterId) els.inputFilterId.value = '';
    if (els.inputFilterDest) els.inputFilterDest.value = '';
    if (els.inputFilterType) els.inputFilterType.value = 'ANY';
    if (els.inputFilterMsgType) els.inputFilterMsgType.value = 'ANY';
    if (els.radFilterCriteria) {
        els.radFilterCriteria.forEach(r => r.checked = (r.value === 'OR'));
    }

    if (els.btnFilter) {
        els.btnFilter.classList.remove('filter-active');
        els.btnFilter.disabled = true;
    }

    ui.renderList();
    ui.clearDetails();
}

ui.updateVisibility = function (isConnected) {
    if (!isConnected) {
        if (els.elPrompt) els.elPrompt.classList.remove('hidden');
        if (els.elActiveView) els.elActiveView.classList.add('hidden');
    } else {
        if (els.elPrompt) els.elPrompt.classList.add('hidden');
        if (els.elActiveView) els.elActiveView.classList.remove('hidden');

        if (els.selectBound && els.selectBound.value) {
            els.hdrQueueName.textContent = els.selectBound.value;
            // updatePermissionUI is called by logic
        } else {
            els.hdrQueueName.textContent = '';
            els.hdrPermissions.classList.add('hidden');
        }
    }
}

ui.resetUI = function () {
    if (els.selectBound) {
        while (els.selectBound.options.length > 1) {
            els.selectBound.remove(1);
        }
        els.selectBound.selectedIndex = 0;
        els.selectBound.dispatchEvent(new Event('change'));
    }
    ui.updateVisibility(false);
}

// Forward Modal Functions
ui.showForwardModal = function (msgs) {
    if (!els.modalForward) return;

    // Handle Single or Array & Prepare State Objects
    const msgArray = Array.isArray(msgs) ? msgs : [msgs];
    state.forwardQueue = msgArray.map(m => ({
        originalMsg: m,
        id: m.id, // Display ID
        correlationValue: ui.generateUuid(), // New Random ID
        status: 'QUEUED', // QUEUED, SENDING, SUCCESS, FAILED
        error: null
    }));

    // Reset Inputs
    els.inputForwardDestName.value = '';
    els.inputForwardDestType.value = 'Topic'; // Default
    els.elForwardError.style.display = 'none';
    els.elForwardError.textContent = '';

    // Enable Send Button initially (User flow: Review -> Send)
    els.btnForwardSend.disabled = false;
    els.btnForwardSend.textContent = 'Send';
    els.btnForwardSend.classList.remove('btn-secondary');
    els.btnForwardSend.classList.add('btn-primary');
    state.forwardingCancelled = false; // Reset Cancel Flag

    // Update Header Count (Label)
    const countEl = document.getElementById('forward-queue-count');
    if (countEl) {
        countEl.textContent = state.forwardQueue.length;
    }

    ui.renderForwardList();

    els.modalForward.classList.remove('hidden');
    els.inputForwardDestName.focus();
}

ui.generateUuid = function () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

ui.getStatusIcon = function (status) {
    // QUEUED: Solid Gray Circle
    if (status === 'QUEUED') {
        // Use a safe fallback color if var is missing, but --text-muted is standard
        return '<svg width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="var(--text-muted, #9ca3af)"/></svg>';
    }
    // SENT: Hollow Green Spinner (Donut)
    if (status === 'SENDING') {
        return '<svg class="icon-spin" width="16" height="16" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10" fill="none" stroke="var(--status-connected)" stroke-width="3" stroke-linecap="round"/></svg>';
    }
    // SUCCESS: Green Tick
    if (status === 'SUCCESS') {
        return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--status-connected)" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
    }
    // FAILED: Solid Red Circle
    if (status === 'FAILED') {
        return '<svg width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="var(--status-disconnected)"/></svg>';
    }
    return '';
}

ui.renderForwardList = function () {
    if (!els.listForwardMsgs) return;

    els.listForwardMsgs.innerHTML = state.forwardQueue.map(item => {
        const icon = ui.getStatusIcon(item.status);
        const hasError = item.status === 'FAILED' && item.error;

        // Content Cleaning & Truncation (Strict 10 chars)
        let cleanContent = (item.originalMsg.content || '').replace(/(\r\n|\n|\r)/gm, " ");
        let maxLen = 30;
        if (cleanContent.length > maxLen) {
            cleanContent = cleanContent.substring(0, maxLen) + '...';
        }

        // Structure: Icon (Left) | Wrapper (Right: ContentRow + ErrorRow)
        return `
            <div class="flex-row gap-2 items-start mb-2">
                <div id="status-${item.correlationValue}" class="flex-shrink-0 mt-2" style="width: 16px;">
                    ${icon}
                </div>
                <div class="flex-col flex-1 min-w-0 gap-0">
                    <div class="flex-row justify-between items-center p-2 rounded border" style="background: var(--bg-input); border-color: var(--border-color);">
                        <span class="text-sm text-secondary whitespace-nowrap mr-2">${item.id}</span>
                        <span class="text-xs text-secondary whitespace-nowrap">${cleanContent}</span>
                    </div>
                    <div id="error-${item.correlationValue}" class="text-xs text-error text-left ${hasError ? '' : 'hidden'}" style="color: var(--status-disconnected); margin-top: 2px;">
                        ${item.error || ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

ui.closeForwardModal = function () {
    if (!els.modalForward) return;
    els.modalForward.classList.add('hidden');
    state.selectedForwardMsg = null;
}

ui.onForwardSuccess = function () {
    ui.closeForwardModal();
    // Maybe show toast? User just said close.
    // Ensure error is cleared if reopen? Done in show.
}

ui.onForwardFailure = function (err) {
    if (els.elForwardError) {
        els.elForwardError.textContent = `Error: ${err.message || err}`;
        els.elForwardError.style.display = 'block';
    }
}

// New Function: Render Headers with Truncation
// Status Update Logic
// Status Update Logic
ui.updateForwardItemStatus = function (correlationValue, status, errorMsg) {
    if (!correlationValue || !state.forwardQueue) return;

    const item = state.forwardQueue.find(m => m.correlationValue === correlationValue);
    if (item) {
        item.status = status;
        item.error = errorMsg;

        // Update Icon
        const iconContainer = document.getElementById(`status-${correlationValue}`);
        if (iconContainer) {
            iconContainer.innerHTML = ui.getStatusIcon(status);
        }

        // Handle Error Text
        const errorContainer = document.getElementById(`error-${correlationValue}`);
        if (errorContainer) {
            if (status === 'FAILED' && errorMsg) {
                errorContainer.textContent = errorMsg;
                errorContainer.classList.remove('hidden');
            } else {
                errorContainer.classList.add('hidden');
            }
        }
    }

    // Check Completion
    ui.checkForwardCompletion();
}

ui.checkForwardCompletion = function () {
    // If all are final (SUCCESS or FAILED), update button
    const isComplete = state.forwardQueue.every(m => m.status === 'SUCCESS' || m.status === 'FAILED');
    if (isComplete && els.btnForwardSend) {
        els.btnForwardSend.textContent = 'Send Complete';
        els.btnForwardSend.disabled = true; // Stay disabled
        els.btnForwardSend.classList.add('btn-secondary');
        els.btnForwardSend.classList.remove('btn-primary');
    }
}

// Consolidate Render Function
ui.renderTags = function (container, properties) {
    if (!container) return;
    container.innerHTML = ''; // Clear

    if (!properties || Object.keys(properties).length === 0) {
        const empty = document.createElement('span');
        empty.textContent = 'None';
        empty.style.color = 'var(--text-secondary)';
        empty.style.fontStyle = 'italic';
        empty.style.fontSize = '0.85rem';
        container.appendChild(empty);
        return;
    }

    for (const [key, val] of Object.entries(properties)) {
        if (val !== null && val !== undefined && val !== '') {
            ui.createTag(container, key, val);
        }
    }
}

ui.createTag = function (container, key, val) {
    const valStr = String(val);
    const tag = document.createElement('span');
    tag.className = 'header-tag';

    const isLong = valStr.length > 20;

    const render = (expanded) => {
        let displayVal = valStr;
        if (!expanded && isLong) {
            displayVal = valStr.substring(0, 20) + '...';
        }
        tag.textContent = `${key} = ${displayVal}`;
    };

    render(false); // Initial render truncated

    if (isLong) {
        let expanded = false;
        tag.onclick = () => {
            expanded = !expanded;
            render(expanded);
        };
        tag.title = 'Click to expand/collapse';
    }

    container.appendChild(tag);
}

// Dynamic Property Filter Rows
ui.addPropertyFilterRow = function (key = '', value = '') {
    const container = els.filterPropsRows || document.getElementById('filter-properties-rows');
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'flex-row gap-2 mt-1 property-filter-row';
    row.innerHTML = `
        <input type="text" class="form-control prop-key" placeholder="Key" list="standard-properties-list" value="${key}">
        <input type="text" class="form-control prop-value" placeholder="Value" value="${value}">
        <button class="btn-icon btn-remove-prop" title="Remove" style="color: var(--status-disconnected);">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        </button>
    `;

    // Attach Remove Listener
    row.querySelector('.btn-remove-prop').onclick = () => row.remove();

    // Attach Enter Key Listener to Apply Filter
    const handleEnter = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (els.btnFilterApply) els.btnFilterApply.click();
            else {
                const btn = document.getElementById('btn-filter-apply');
                if (btn) btn.click();
            }
        }
    };
    row.querySelector('.prop-key').addEventListener('keydown', handleEnter);
    row.querySelector('.prop-value').addEventListener('keydown', handleEnter);

    container.appendChild(row);
}

ui.getPropertyFilters = function () {
    const container = els.filterPropsRows || document.getElementById('filter-properties-rows');
    if (!container) return [];

    const rows = container.querySelectorAll('.property-filter-row');
    const filters = [];
    rows.forEach(row => {
        const key = row.querySelector('.prop-key').value.trim();
        const value = row.querySelector('.prop-value').value.trim();
        if (key) { // Value acts as partial match, empty value might mean "exists"? Let's require value for now or allow empty.
            // If value is empty, it matches anything with that key? Plan says Match ANY/ALL.
            // Let's assume value is partial match string. Empty string matches all strings.
            filters.push({ key, value });
        }
    });
    return filters;
}

ui.clearPropertyFilters = function () {
    const container = els.filterPropsRows || document.getElementById('filter-properties-rows');
    if (container) container.innerHTML = '';
}

ui.getElements = function () {
    return els;
}

// import * as ui from './ui.js';
// import * as uiEvents from './ui-events.js';
// import * as service from './service.js';

function setup(context) {
    const { container, appState, loadSelf } = context;

    // Initialize UI Elements
    const els = ui.initElements(container);

    // Bind UI Events

    // JSZip Loaded Handler
    function showZipButtons() {
        if (els.btnBrowserDownloadContent) els.btnBrowserDownloadContent.classList.remove('hidden');
        if (els.btnBrowserDownloadFull) els.btnBrowserDownloadFull.classList.remove('hidden');
    }

    if (window.JSZip) {
        showZipButtons();
    } else {
        window.addEventListener('jszip:loaded', showZipButtons);
    }

    // Bind Button

    // Bind Button
    if (els.btnBind) {
        els.btnBind.onclick = uiEvents.handleBindClick;
    }

    // Input Enter Key
    if (els.inputBind) {
        els.inputBind.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                els.btnBind.click();
            }
        });
    }

    // Unbind Button
    if (els.btnUnbind) {
        els.btnUnbind.addEventListener('click', uiEvents.handleUnbindClick);
    }

    // Dropdown Change
    if (els.selectBound) {
        els.selectBound.addEventListener('change', uiEvents.handleDropdownChange);
    }

    // Refresh
    if (els.btnRefresh) {
        els.btnRefresh.addEventListener('click', uiEvents.applyFilters);
    }

    // Check All
    if (els.checkAll) {
        els.checkAll.addEventListener('change', () => {
            const checks = els.msgList.querySelectorAll('.msg-check');
            checks.forEach(c => c.checked = els.checkAll.checked);
            ui.updateCounts();
        });
    }

    // Filter Controls
    if (els.btnFilter) {
        els.btnFilter.addEventListener('click', () => {
            if (els.modalFilter) els.modalFilter.classList.remove('hidden');
        });
    }
    if (els.btnFilterCancel) {
        els.btnFilterCancel.addEventListener('click', () => {
            if (els.modalFilter) els.modalFilter.classList.add('hidden');
        });
    }
    if (els.btnFilterApply) {
        els.btnFilterApply.addEventListener('click', uiEvents.applyFilters);
    }
    if (els.btnFilterClear) {
        els.btnFilterClear.addEventListener('click', uiEvents.clearFilters);
    }
    if (els.btnAddPropFilter) {
        els.btnAddPropFilter.addEventListener('click', () => ui.addPropertyFilterRow());
    }

    // Copy Content
    if (els.btnCopyContent) {
        els.btnCopyContent.addEventListener('click', uiEvents.handleCopyContent);
    }

    // Bulk Actions
    if (els.btnBrowserDownloadContent) {
        els.btnBrowserDownloadContent.addEventListener('click', uiEvents.handleBulkDownloadContent);
    }
    if (els.btnBrowserDownloadFull) {
        els.btnBrowserDownloadFull.addEventListener('click', uiEvents.handleBulkDownloadFull);
    }
    if (els.btnBrowserDelete) {
        els.btnBrowserDelete.addEventListener('click', uiEvents.handleBulkDelete);
    }

    // Enter key for filters
    [els.inputFilterContent, els.inputFilterId, els.inputFilterDest].forEach(input => {
        if (input) {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    els.btnFilterApply.click();
                }
            });
        }
    });

    // Global Listeners
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            state.forwardingCancelled = true; // Stop any active loop
            const openModals = document.querySelectorAll('.modal-backdrop:not(.hidden)');
            openModals.forEach(modal => modal.classList.add('hidden'));
        }
    });

    window.addEventListener('app:state-change', (e) => {
        if (e.detail.key === 'isConnected') {
            ui.updateVisibility(e.detail.value);
            if (e.detail.value) {
                ui.renderList();
                // Attach Session Events for Forwarding (Via Global Dispatch)
                // Note: listeners added once or managed? `window.addEventListener` should be outside this block?
                // Actually, if we add them here, we might retain them. 
                // Better to add them at the top level (lines 116+).
                // But for now, let's keep it clean: WE DO NOT Need to do anything here if we move listeners to global scope.
                // Or if we want to bind them only when connected.
            }
        }
        if (e.detail.key === 'selectedVpn') {
            if (els.hdrVpnName) els.hdrVpnName.textContent = e.detail.value;
        }
    });

    // Global Session Events (Forwarding)
    window.addEventListener('client:session-ack', (e) => {
        if (serviceEvents && serviceEvents.onSessionAck) serviceEvents.onSessionAck(e.detail);
    });
    window.addEventListener('client:session-reject', (e) => {
        if (serviceEvents && serviceEvents.onSessionReject) serviceEvents.onSessionReject(e.detail);
    });

    // Message Actions
    window.addEventListener('app:message-delete', (e) => {
        if (e.detail && e.detail.id) {
            uiEvents.handleDelete(e.detail.id);
        }
    });

    // Forward Modals
    // Bulk Forward
    if (els.btnBrowserForward) {
        els.btnBrowserForward.addEventListener('click', uiEvents.handleBulkForward);
    }

    if (els.btnForwardCancel) {
        els.btnForwardCancel.addEventListener('click', () => {
            state.forwardingCancelled = true;
            ui.closeForwardModal();
        });
    }
    if (els.btnForwardClose) {
        els.btnForwardClose.addEventListener('click', () => {
            state.forwardingCancelled = true;
            ui.closeForwardModal();
        });
    }
    if (els.btnForwardSend) {
        els.btnForwardSend.addEventListener('click', uiEvents.handleForwardSend);
    }
    // Bulk Forward Button
    if (els.btnBrowserForward) {
        els.btnBrowserForward.addEventListener('click', () => {
            // Logic: Get selected IDs, find msgs, show modal
            const checkedBoxes = els.msgList.querySelectorAll('.msg-check:checked');
            const msgs = [];
            checkedBoxes.forEach(chk => {
                const tr = chk.closest('tr');
                const id = tr.dataset.id;
                const msg = state.displayedMessages.find(m => m.id === id);
                if (msg) msgs.push(msg);
            });

            if (msgs.length > 0) {
                ui.showForwardModal(msgs);
            }
        });
    }

    // Initial check
    if (appState.isConnected) {
        ui.updateVisibility(true);
    }

    // Cross-Module: Handle "Browse Queue" request
    window.addEventListener('browser:browse-queue', (e) => {
        console.log('[Browser] Received Browse Request:', e.detail);
        const targetQueue = e.detail.queue;

        // 1. Switch View to Browser
        if (loadSelf)
            loadSelf();

        // 2. Bind Logic
        // We need to wait for view to be visible? Usually instant.
        setTimeout(() => {
            // Check if queue is already bound (regardless of current display)
            if (state.browserInstances && state.browserInstances.has(targetQueue)) {
                console.log('[Browser] Queue already bound. Switching view to:', targetQueue);

                // Update Dropdown and Trigger Change
                if (els.selectBound) {
                    els.selectBound.value = targetQueue;
                    els.selectBound.dispatchEvent(new Event('change'));
                }
            } else {
                console.log('[Browser] Binding to new queue:', targetQueue);
                if (els.inputBind) els.inputBind.value = targetQueue;
                if (els.btnBind) els.btnBind.click();
            }
        }, 100);
    });
    ui.renderList();
    // Global Listeners handle session events now.


    if (appState.selectedVpn && els.hdrVpnName) {
        els.hdrVpnName.textContent = appState.selectedVpn;
    }

    // Cleanup
    window.addEventListener('client:disconnected', () => {
        service.disconnectAll();
        ui.resetUI();
    });
}

// No export default needed

            // Explicitly return the exported setup function if it exists
            return typeof setup === 'function' ? setup : null;
        })();

        if (window.App && window.App.registerModule) {
            window.App.registerModule('03-queue-browser', moduleLogic);
        }
    } catch (e) {
        console.error('Failed to load module 03-queue-browser', e);
    }
})();


    </script>
<template id="module-tpl-01-connections">
<div class="card">
    <div class="flex-row justify-between items-center mb-4">
        <h2 class="m-0">Broker Configuration</h2>
    </div>
    <div class="form-group">
        <label>Broker Host (IP or Hostname)</label>
        <input type="text" id="conn-host" class="form-control"
            placeholder="e.g. localhost or my-broker.solace.cloud or 192.168.0.10" value="localhost">
        <div class="invalid-feedback">Invalid hostname or IP address.</div>
    </div>
</div>

<div class="card">
    <div class="flex-row justify-between items-center mb-4">
        <div class="flex-row items-center gap-4">
            <h2 class="m-0">Solace Messaging (Client)</h2>
            <button id="btn-solace-settings" class="btn-icon items-center flex" title="Connection Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
        </div>
        <!-- Auth Mode Toggle -->
        <div class="auth-toggle flex-row gap-4" style="font-size: 0.9rem;">
            <label class="flex-row items-center font-normal cursor-pointer gap-1">
                <input type="radio" name="solace-auth-mode" value="basic" checked> Basic
            </label>
            <label class="flex-row items-center font-normal cursor-pointer gap-1">
                <input type="radio" name="solace-auth-mode" value="oauth"> OAuth2
            </label>
        </div>
    </div>

    <div class="form-group flex-row">
        <div style="width: 150px;">
            <label>Protocol</label>
            <select id="solace-protocol" class="form-control">
                <option value="ws">ws://</option>
                <option value="wss" selected>wss://</option>
                <option value="http" disabled>http://</option>
                <option value="https" disabled>https://</option>
            </select>
        </div>
        <div style="width: 100px;">
            <label>Port</label>
            <input type="text" id="solace-port" class="form-control" placeholder="8008 or 1443">
            <div class="invalid-feedback">Invalid port.</div>
        </div>
        <div class="w-full">
            <label>Message VPN</label>
            <input type="text" id="solace-vpn" class="form-control" placeholder="default">
            <div class="invalid-feedback">Message VPN is required.</div>
        </div>
    </div>
    <div class="form-group flex-row">
        <div class="w-full">
            <label id="lbl-solace-username">Username</label>
            <input type="text" id="solace-username" class="form-control" placeholder="default">
            <div class="invalid-feedback">Field is required.</div>
        </div>
        <div class="w-full">
            <label id="lbl-solace-password">Password</label>
            <input type="password" id="solace-password" class="form-control">
        </div>
    </div>
    <button id="btn-solace-connect" class="btn btn-primary">Connect</button>
    <div id="solace-connect-error" class="text-error mt-2 hidden" style="font-size: 0.9rem;"></div>
</div>

<div class="card">
    <div class="flex-row justify-between items-center mb-4">
        <h2 class="m-0">SEMP (Management)</h2>
    </div>
    <div class="form-group flex-row">
        <div style="width: 150px;">
            <label>Protocol</label>
            <select id="semp-protocol" class="form-control">
                <option value="http">http://</option>
                <option value="https" selected>https://</option>
            </select>
        </div>
        <div style="width: 100px;">
            <label>Port</label>
            <input type="text" id="semp-port" class="form-control" placeholder="8080 or 1943">
            <div class="invalid-feedback">Invalid port.</div>
        </div>
        <div class="w-full"></div> <!-- Spacer -->
    </div>
    <div class="form-group flex-row">
        <div class="w-full">
            <label>Username</label>
            <input type="text" id="semp-username" class="form-control" placeholder="admin">
            <div class="invalid-feedback">Username is required.</div>
        </div>
        <div class="w-full">
            <label>Password</label>
            <input type="password" id="semp-password" class="form-control">
            <div class="invalid-feedback">Password is required.</div>
        </div>
    </div>
    <button id="btn-semp-connect" class="btn btn-primary">Connect</button>
    <div id="semp-connect-error" class="text-error mt-2 hidden" style="font-size: 0.9rem;"></div>
</div>

<div class="actions-footer mt-6 flex-row justify-end p-6 gap-4">
    <button id="btn-reset-form" class="btn btn-secondary">Reset Form</button>
    <button id="btn-load-config" class="btn btn-secondary">Load All Config</button>
    <button id="btn-save-config" class="btn btn-primary"
        style="background-color: var(--status-warning); border-color: var(--status-warning); color: #000;">Save All
        Config</button>
</div>

<!-- Solace Advanced Settings Modal -->
<div id="solace-settings-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <h3>Advanced Connection Settings</h3>
        <div class="form-group">
            <label>Connect Retries</label>
            <input type="number" id="sol-connect-retries" class="form-control" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Connect Timeout (ms)</label>
            <input type="number" id="sol-connect-timeout" class="form-control" value="3000" min="100">
        </div>
        <div class="form-group">
            <label>Reconnect Retries</label>
            <input type="number" id="sol-reconnect-retries" class="form-control" value="1" min="-1">
            <small class="text-secondary" style="font-size: 0.75rem;">-1 for infinite</small>
        </div>
        <div class="form-group">
            <label>Reconnect Wait (ms)</label>
            <input type="number" id="sol-reconnect-wait" class="form-control" value="3000" min="100">
        </div>
        <div class="flex-row justify-between mt-4">
            <button id="btn-cancel-settings" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- SSL Trust Modal -->
<div id="ssl-trust-modal" class="modal-backdrop hidden" style="z-index: 9999;">
    <div class="modal-content flex-col gap-4" style="max-width: 500px;">
        <div class="flex-row justify-between items-center">
            <h3 class="m-0">Certificate Trust Helper</h3>
            <button id="btn-close-ssl-modal" class="btn-icon" title="Close" style="font-size: 1.5rem;">&times;</button>
        </div>

        <div class="text-secondary" style="line-height: 1.5;">
            <p class="mt-0">The browser may have blocked the connection because the broker's certificate is
                not trusted.</p>

            <div class="p-4"
                style="background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color); margin: 0.5rem 0;">
                <strong>Step 1:</strong> Click the link below to open the broker in a new tab.<br>
                <strong>Step 2:</strong> If you see a privacy warning, click <strong>Advanced</strong> and then
                <strong>Proceed</strong> (or Accept).<br>
                <strong>Step 3:</strong> Once the page loads, close that tab and return here to connect.
            </div>
        </div>

        <div class="text-center mt-2">
            <a id="ssl-trust-link" href="#" target="_blank" class="btn btn-primary"
                style="display: inline-block; text-decoration: none; padding: 0.5rem 1.5rem;">
                Open Broker URL ↗
            </a>
            <div id="ssl-trust-url-text" class="text-secondary mt-2"
                style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">
            </div>
        </div>
    </div>
</div>
</template>
<template id="module-tpl-02-queue-discovery">
<div class="card">

    <!-- Warning State -->
    <div id="discovery-warning" class="hidden text-center p-6 text-secondary">
        <h2 class="mb-4 text-secondary">Connection Required</h2>
        <p>Please establish a SEMP connection to discover queues.</p>
    </div>

    <!-- Main Content -->
    <div id="discovery-content">
        <div class="form-group">
            <label>Message VPN</label>
            <div class="flex-row items-center gap-2">
                <div class="searchable-select-container">
                    <input type="text" id="discovery-vpn-input" class="form-control" placeholder="Select a Message VPN"
                        autocomplete="off">
                    <div class="searchable-select-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div id="discovery-vpn-list" class="dropdown-options">
                        <!-- Options populated via JS -->
                    </div>
                </div>
                <button id="btn-refresh-vpns" class="btn btn-secondary">Refresh</button>
            </div>
        </div>

        <div class="form-group" id="queue-select-group">
            <label>Queue List</label>
            <div class="flex-row items-center gap-2">
                <div class="searchable-select-container">
                    <input type="text" id="discovery-queue-input" class="form-control" placeholder="Select a Queue"
                        autocomplete="off">
                    <div class="searchable-select-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div id="discovery-queue-list" class="dropdown-options">
                        <!-- Options populated via JS -->
                    </div>
                </div>
                <button id="btn-refresh-queues" class="btn btn-secondary">Refresh</button>
            </div>

            <div class="mt-4">
                <button id="btn-copy-config" class="btn btn-primary" disabled>Open in Browser</button>
            </div>
        </div>
    </div>
</div>
</template>
<template id="module-tpl-03-queue-browser">
<!-- Connection Prompt (Visible when Disconnected) -->
<div id="browser-connect-prompt" class="card text-center p-6">
    <h2 class="mb-4 text-secondary">Connection Required</h2>
    <p class="text-secondary">Please establish a Solace Client connection to browse queues.</p>
</div>

<!-- Active View (Visible when Connected) -->
<div id="browser-active-view" class="hidden">
    <!-- QB Session Panel -->
    <div class="card mb-4" id="browser-panel-manager">
        <h2 class="mb-4">QB Session</h2>
        <div class="flex-row items-start gap-4">
            <div class="flex-1">
                <label>Queue Name</label>
                <div class="flex-col w-full gap-1">
                    <div class="flex-row gap-2">
                        <input type="text" id="browser-bind-input" class="form-control"
                            placeholder="Enter Queue Name to Bind">
                        <button id="btn-browser-bind" class="btn btn-primary">Bind</button>
                    </div>
                    <!-- Error Feedback -->
                    <div id="browser-bind-error" class="invalid-feedback"></div>
                </div>
            </div>
            <div class="flex-1">
                <label>Bound Queues</label>
                <div class="flex-row gap-2">
                    <select id="browser-bound-queues" class="form-control">
                        <option value="" disabled selected>Select a Queue</option>
                    </select>
                    <button id="btn-browser-unbind" class="btn btn-secondary text-error"
                        title="Unbind Selected Queue">Unbind</button>
                </div>
            </div>
        </div>
    </div>
    <div id="browser-connect-error" class="text-error mt-2 hidden" style="font-size: 0.9rem;"></div>

    <!-- Message List & Details Panel -->
    <div class="card">
        <div class="flex-row justify-between items-center mb-2">
            <div class="flex-row items-center gap-2" style="min-width: 0; flex: 1;">
                <h2 class="m-0 flex-row items-center" style="min-width: 0; flex: 1; white-space: nowrap;">
                    <span id="browser-vpn-name" class="text-accent flex-shrink-0"></span>
                    <span class="flex-shrink-0 mx-2">::</span>
                    <div style="overflow-x: auto; flex: 1; display: flex; align-items: center;">
                        <span id="browser-queue-name" style="white-space: nowrap;"></span>
                    </div>
                </h2>
                <span id="browser-permissions" class="badge flex-shrink-0"></span>
            </div>
            <div class="flex-row items-center gap-2 flex-shrink-0 pl-2">
                <button id="btn-browser-filter" class="btn-icon" title="Filter Messages" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Info Bar -->
        <div class="browser-info-bar">
            <div class="info-group">
                <span class="info-count">Total: <strong id="count-total">-</strong></span>
                <span class="info-count">Displayed: <strong id="count-displayed">-</strong></span>
                <span class="info-count">Selected: <strong id="count-selected">0</strong></span>
            </div>
            <div class="flex-row items-center gap-2">
                <button id="btn-browser-download-content" class="btn btn-secondary btn-sm hidden hover-success" disabled
                    title="Download Content Only">Download Content</button>
                <button id="btn-browser-download-full" class="btn btn-secondary btn-sm hidden hover-success" disabled
                    title="Download Full Message (JSON)">Download Full</button>
                <button id="btn-browser-forward" class="btn btn-secondary btn-sm hover-success" disabled
                    title="Forward Selected">Forward</button>
                <button id="btn-browser-delete" class="btn btn-secondary btn-sm hover-danger" disabled
                    title="Delete Selected">Delete</button>
            </div>
        </div>

        <div id="browser-content">
            <!-- Message List -->
            <div class="mb-6 overflow-auto"
                style="max-height: 300px; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="browser-select-all"></th>
                            <th>Message ID</th>
                            <th>Date</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="browser-msg-list">
                        <!-- Mock Rows Injected by JS -->
                    </tbody>
                </table>
            </div>

            <hr class="divider mb-6">

            <!-- Message Details (Always Visible) -->
            <div class="card-light" id="browser-details-panel">
                <div class="flex-row justify-between items-center mb-4">
                    <div class="flex-row items-center gap-2">
                        <h3 class="text-secondary m-0" style="font-size: 1rem;">Message Details</h3>
                        <span id="detail-type-badge" class="badge badge-outline-info hidden"></span>
                    </div>
                    <button id="btn-show-raw" class="btn btn-secondary btn-sm" disabled>Show Raw Content</button>
                </div>

                <div class="flex-row mb-6 gap-4">
                    <div class="flex-1">
                        <div class="detail-header-row">
                            <div class="detail-label">Message ID</div>
                        </div>
                        <div class="flex-row items-center gap-2">
                            <div id="detail-msg-id" class="display-output single-line flex-1"></div>
                        </div>
                    </div>
                    <div class="flex-3">
                        <div class="detail-header-row">
                            <div class="detail-label">Destination</div>
                            <button id="btn-copy-dest" class="btn btn-secondary btn-sm" title="Copy Destination"
                                disabled>
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex-row items-center gap-2">
                            <div id="detail-destination" class="display-output single-line flex-1"></div>
                            <span id="detail-dest-badge" class="badge badge-outline-success hidden"></span>
                        </div>
                    </div>
                    <div class="flex-2">
                        <div class="detail-header-row">
                            <div class="detail-label">Repl Grp Msg Id</div>
                            <button id="btn-copy-repl-msg-id" class="btn btn-secondary btn-sm"
                                title="Copy Repl Grp Msg Id" disabled>
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex-row items-center gap-2">
                            <div id="detail-repl-msg-id" class="display-output single-line flex-1"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="detail-label">Message Properties</div>
                    <div id="detail-properties-container" class="display-output flex-wrap"></div>
                </div>

                <div class="form-group">
                    <div class="detail-label">Application / User Properties</div>
                    <div id="detail-headers-container" class="display-output flex-wrap"></div>
                </div>

                <div class="form-group">
                    <div class="detail-header-row">
                        <div class="detail-label">Content Preview</div>
                        <button id="btn-copy-content" class="btn btn-secondary btn-sm" disabled
                            title="Copy content to clipboard">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="detail-content" class="display-output multi-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal (Portal/Overlay) -->
<div id="browser-filter-modal" class="modal-backdrop hidden">
    <div class="modal-content modal-lg">
        <h3 class="mb-4">Filter Messages</h3>

        <!-- Criteria Selection -->
        <div class="form-group">
            <label>Search Criteria</label>
            <div class="flex-row gap-4 mt-1">
                <label class="flex-row items-center gap-2 font-normal cursor-pointer">
                    <input type="radio" name="filter-criteria" value="OR" checked> Match ANY (OR)
                </label>
                <label class="flex-row items-center gap-2 font-normal cursor-pointer">
                    <input type="radio" name="filter-criteria" value="AND"> Match ALL (AND)
                </label>
            </div>
        </div>

        <!-- Message ID & Type -->
        <div class="form-group flex-row">
            <div class="w-full">
                <label>Message ID</label>
                <input type="text" id="filter-msg-id" class="form-control" placeholder="e.g. 1023">
            </div>
            <div style="width: 200px;">
                <label>Message Type</label>
                <select id="filter-msg-type" class="form-control">
                    <option value="ANY" selected>Any</option>
                    <option value="Text">Text</option>
                    <option value="Binary">Binary</option>
                    <option value="Map">Map</option>
                    <option value="Stream">Stream</option>
                </select>
            </div>
        </div>

        <!-- Destination -->
        <div class="form-group flex-row">
            <div class="w-full">
                <label>Destination Name</label>
                <input type="text" id="filter-destination" class="form-control" placeholder="e.g. queue/topic/name">
            </div>
            <div style="width: 150px;">
                <label>Type</label>
                <select id="filter-destination-type" class="form-control">
                    <option value="ANY" selected>Any</option>
                    <option value="Topic">Topic</option>
                    <option value="Queue">Queue</option>
                </select>
            </div>
        </div>

        <!-- Properties Filter -->
        <div class="form-group">
            <div class="flex-row justify-between items-center mb-2">
                <label class="m-0">Properties Filter (Key / Value)</label>
                <button id="btn-add-prop-filter" class="btn btn-secondary btn-sm">+ Add</button>
            </div>
            <div id="filter-properties-rows" class="flex-col gap-2">
                <!-- Dynamic Rows Go Here -->
            </div>
            <datalist id="standard-properties-list">
                <option value="App Msg Id"></option>
                <option value="Cache Id"></option>
                <option value="Corr Id"></option>
                <option value="Delivery Count"></option>
                <option value="Delivery Mode"></option>
                <option value="HTTP Encoding"></option>
                <option value="HTTP Type"></option>
                <option value="Priority"></option>
                <option value="Reply To"></option>
                <option value="Sender Id"></option>
                <option value="SeqNumber"></option>
                <option value="TTL"></option>
                <option value="TopicSeqNum"></option>
            </datalist>
        </div>

        <!-- Body -->
        <div class="form-group">
            <label>Body Content (Contains)</label>
            <input type="text" id="filter-content" class="form-control" placeholder="e.g. orderId">
        </div>

        <div class="flex-row justify-between gap-2 mt-4">
            <button id="btn-filter-clear" class="btn btn-secondary text-error">Clear Filter</button>
            <div class="flex-row gap-2">
                <button id="btn-filter-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-filter-apply" class="btn btn-primary">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Raw Content Modal -->
<div id="browser-raw-content-modal" class="modal-backdrop hidden">
    <div class="modal-content modal-lg">
        <div class="flex-row justify-between items-center mb-4">
            <h3 class="m-0">Raw Content</h3>
            <button id="btn-raw-close" class="btn-icon" title="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <pre id="raw-content-text"
            style="max-height: calc(90vh - 120px); overflow: auto; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border-color);"></pre>
    </div>
</div>

<!-- Forward Message Modal -->
<div id="browser-forward-modal" class="modal-backdrop hidden">
    <div class="modal-content modal-lg">
        <div class="flex-row justify-between items-center mb-4">
            <h3 class="m-0">Forward Message</h3>
            <button id="btn-forward-close" class="btn-icon" title="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="form-group">
            <label>Destination Type</label>
            <select id="forward-dest-type" class="form-control">
                <option value="Topic">Topic</option>
                <option value="Queue">Queue</option>
            </select>
        </div>
        <div class="form-group">
            <label>Destination Name</label>
            <input type="text" id="forward-dest-name" class="form-control" placeholder="Queue Or Topic Name">
        </div>
        <div id="forward-error" class="invalid-feedback mb-2" style="display: none;"></div>

        <!-- Queue List -->
        <div class="form-group">
            <label><span id="forward-queue-count" class="badge mr-2">0</span>Messages to Forward</label>
            <div id="forward-msg-list" class="display-output flex-col gap-1"
                style="max-height: calc(90vh - 300px); overflow-y: auto;">
                <!-- Dynamic Items -->
            </div>
        </div>

        <div class="flex-row justify-end gap-2 mt-4">
            <button id="btn-forward-cancel" class="btn btn-secondary">Cancel</button>
            <button id="btn-forward-send" class="btn btn-primary" disabled>Send</button>
        </div>
    </div>
</div>

</div>
</div>
</template>
</body>

</html>